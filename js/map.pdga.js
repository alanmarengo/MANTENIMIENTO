function ol_map() {

	this.container = {};
	this.nav = {};
	this.panel = {};
	this.panel.div = document.getElementById("nav-panel");
	this.map = {};
	this.map.infoEnabled = true;
	this.popup = {};
	this.map.baselayers = {};
	this.map.layersBuffer = [];
	this.map.layersBufferIndex = 0;
	this.map.layersStats = [];
	this.map.layersStatsIndex = 200000;
	
	this.map.geovisor = -1;
		
	$(".datepicker").datepicker({
		
		language: 'es'
		
	});
	
	// MAP SCRIPTS 
	
	this.map.create = function() {
		
		this.baselayers.openstreets = new ol.layer.Tile({
			name: 'openstreets',
			title: 'OSM',
			type: 'base',
			visible: false,
			source: new ol.source.XYZ({
				url: '//{a-c}.tile.openstreetmaps.org/{z}/{x}/{y}.png',
				crossOrigin: 'anonymous'
			})
		})
	
		this.baselayers.opentopo = new ol.layer.Tile({
			name: 'opentopo',
			title: 'OpenTopo',
			type: 'base',
			visible: false,
			source: new ol.source.XYZ({
				url: '//{a-c}.tile.opentopomap.org/{z}/{x}/{y}.png',
				crossOrigin: 'anonymous'
			})
		})

		this.baselayers.bingmaps = new ol.source.BingMaps({
			name:'bing',
			key: 'AmqIEhx8ko1O3p1Npagu9_Egw7e8quBgM03p6_xdFqjSfJa6kWv_iUU2nO1htz1G',
			imagerySet: 'Road',
			culture: 'ar-ES',
			visible:false,
			crossOrigin: 'anonymous'
		})

		this.baselayers.bing_roads = new ol.layer.Tile({
			name:'bing_roads',
			preload: Infinity,
			source: this.baselayers.bingmaps,
			visible:false,
			crossOrigin: 'anonymous'
		})

		this.baselayers.bing_aerials = new ol.layer.Tile({
			name:'bing_aerials',
			preload: Infinity,
			visible:true,
			source: new ol.source.BingMaps({
				key: 'AmqIEhx8ko1O3p1Npagu9_Egw7e8quBgM03p6_xdFqjSfJa6kWv_iUU2nO1htz1G',
				imagerySet: 'Aerial',
				crossOrigin: 'anonymous'
			})
		})

		this.baselayers.google = new ol.layer.Tile({
			name:'google_base',
			visible:false,
			source: new ol.source.TileImage({ 
				url: 'http://mt{0-3}.googleapis.com/vt?&x={x}&y={y}&z={z}&hl=es&gl=AR',
				crossOrigin: 'anonymous'
			})
		})		
	
		this.baselayers.argenmap = new ol.layer.Tile({
			name:"capabaseargenmap",
			visible:false,
			source: new ol.source.TileWMS({
				url: "https://wms.ign.gob.ar/geoserver/ows",
				params: {
					'LAYERS': 'capabaseargenmap',
					'VERSION': '1.1.1',
					'FORMAT': 'image/png',
					'TILED': false
				}/*,
				crossOrigin: 'anonymous'*/
			})
		})
	
		/*this.baselayers.argenmap = new ol.layer.Tile({
			name:'capabaseargenmap',
			visible:true,
			source: new ol.source.TileImage({ 
				url: 'https://wms.ign.gob.ar/geoserver/ows',
				crossOrigin: 'anonymous'
			})
		})*/
		
		var layer_872 = new ol.layer.Tile({
			name:"ahrsc:cuenca_mapa_pga",
			visible:true,
			source: new ol.source.TileWMS({
				url: "http://observatorio.ieasa.com.ar/geoserver/ows?",
				params: {
					'LAYERS': "ahrsc:cuenca_mapa_pga",
					'VERSION': '1.1.1',
					'FORMAT': 'image/png',
					'TILED': false,
					'clase_id':-1,
					'layer_id':872
				}/*,
				crossOrigin: 'anonymous'*/
			})
		});
		
		
		var wkt = 'MULTIPOLYGON(-71.7956669619932 -49.8100047833891,-71.7973638181253 -49.8115466029532,-71.7997141868113 -49.8126734224672,-71.8024878036245 -49.8132748307406,-71.8041312888484 -49.8139277516198,-71.8088191137651 -49.8180461307894,-71.8113662655319 -49.8188242827504,-71.8133980608863 -49.8200866177959,-71.8142747093231 -49.8210221436793,-71.8146508182806 -49.8220887721386,-71.8144879967097 -49.8231777217523,-71.814079723313 -49.824078212125,-71.814093758498 -49.8250165972476,-71.8145289134733 -49.825911806056,-71.8158373590953 -49.8269935367957,-71.8164133888821 -49.8283155681761,-71.8162581495552 -49.8293723024804,-71.8167654137757 -49.8303818073762,-71.8178515291002 -49.8311775335381,-71.8199188114868 -49.8324566705225,-71.8223061358031 -49.833476376861,-71.826802372742 -49.8344901619398,-71.8293999579334 -49.8355608204768,-71.8310084264704 -49.8372598844689,-71.8313017578166 -49.8392430896537,-71.831301759191 -49.8392430912753,-71.8361694486159 -49.841468537143,-71.8370240438211 -49.8421828239516,-71.8374730956292 -49.8430379968348,-71.8374677842684 -49.8439411253124,-71.8372559416048 -49.8442431867739,-71.8348551527458 -49.8453944226414,-71.8319978624946 -49.8459616103701,-71.8290116474132 -49.8458797225517,-71.827941963571 -49.8459058430104,-71.8263894943064 -49.8462965467169,-71.8250724099303 -49.8469561742086,-71.8240990952545 -49.8478304494121,-71.8238703122317 -49.8489597163163,-71.8242121381039 -49.8495506133408,-71.8242788778607 -49.8501800178083,-71.8240649669796 -49.8507955514855,-71.8233651664633 -49.8514140727731,-71.822361084853 -49.8518212897259,-71.8218969735379 -49.8523813481435,-71.8218549680496 -49.8530161519051,-71.8222434155157 -49.8535997922646,-71.8233720007925 -49.8542144797456,-71.824788491202 -49.8545184765093,-71.8259685050791 -49.8551093145601,-71.826778139562 -49.8559199534581,-71.8274615624372 -49.8575887338198,-71.8290538589438 -49.8589745141909,-71.8313278217662 -49.8598794989649,-71.8338788585244 -49.8626980988508,-71.8344479076746 -49.8641373958133,-71.8344497914195 -49.8656229535225,-71.8338843420861 -49.8670628480645,-71.8327578732788 -49.8680642033212,-71.8313187730867 -49.8688813020349,-71.8307811583081 -49.8690508006906,-71.8303529699614 -49.8693207655678,-71.8301392514129 -49.8696108557737,-71.8300609571929 -49.8699281451209,-71.8301244616668 -49.870246812064,-71.8307462979419 -49.8712720211599,-71.8320382931497 -49.8719898746388,-71.8365553925498 -49.8735948538947,-71.8409406061086 -49.877449708823,-71.8438992585048 -49.8804966213398,-71.848233370425 -49.8829588270918,-71.8510403626748 -49.8839124205993,-71.8531968845947 -49.8854148882004,-71.8544574138364 -49.8872952203589,-71.8556759674202 -49.8879782219249,-71.8572278451825 -49.8882628819612,-71.8588201102279 -49.8880954666787,-71.8597560216381 -49.8882699811154,-71.8605416513318 -49.8886420733053,-71.8609633516299 -49.889088163813,-71.8611502909006 -49.889596729342,-71.8610840512069 -49.8901176843983,-71.8607279005963 -49.8906634829269,-71.8606406665509 -49.8912531119682,-71.8608303415514 -49.8918326144003,-71.8614386765015 -49.8924275093058,-71.8623184484402 -49.8928580037499,-71.866777829752 -49.8936034426977,-71.8695023970162 -49.8936091451048,-71.8721302462489 -49.8940740129917,-71.87364645359 -49.8945802333583,-71.874818923595 -49.8953814566135,-71.8755161406141 -49.8963878230649,-71.8754173517578 -49.89742266959,-71.8758879789504 -49.8984139119634,-71.8767311456023 -49.8990742778666,-71.8778330761846 -49.8995497660864,-71.8791003564437 -49.8998000653465,-71.8810134717091 -49.9007335959015,-71.8817470467694 -49.9013449685742,-71.8821137822975 -49.9020812944484,-71.8820696750862 -49.9028542587762,-71.8812453858692 -49.9040032915631,-71.8811044277627 -49.9052663938337,-71.8816651177921 -49.9064798947761,-71.8824266454902 -49.9100404351296,-71.8850927012511 -49.9129600035568,-71.8864613458856 -49.9162321469673,-71.886433861949 -49.9196214903045,-71.8867866057728 -49.9200796327739,-71.8873681228738 -49.9204271911683,-71.888102781492 -49.9206189599169,-71.8900227083043 -49.9209771792771,-71.8916249426651 -49.921748408248,-71.8924661117768 -49.9226720830317,-71.8928113320728 -49.9237201460994,-71.8926250896206 -49.9247848777451,-71.8925954668344 -49.9254712619116,-71.8918648765519 -49.9276535772058,-71.8922997252833 -49.9301169230234,-71.8937022943608 -49.9324249921406,-71.8959781678859 -49.9344222016691,-71.8976203295091 -49.9349618278286,-71.8982189248111 -49.9353775701852,-71.8985862922787 -49.9358932203357,-71.8986693972247 -49.9362763014334,-71.8985739749139 -49.9366581850414,-71.8983084897841 -49.9370049801253,-71.8976057335226 -49.9373969625587,-71.8972820004529 -49.9379909290987,-71.8973439965734 -49.9386193018064,-71.8977818586225 -49.939181967247,-71.898742925036 -49.9402214889025,-71.8999989258423 -49.9411205261299,-71.9007143611306 -49.9431401401004,-71.9025809912288 -49.9448256553635,-71.9053103285165 -49.9459164856097,-71.9076163626333 -49.946694017668,-71.9085514672329 -49.9474627616563,-71.908931077332 -49.9484088447328,-71.9087450751153 -49.949135226137,-71.9081982904516 -49.9497814108623,-71.9074855148059 -49.9502499350925,-71.9070106908623 -49.950830601573,-71.9068136503828 -49.951474710707,-71.9071194447619 -49.9521840134938,-71.9070505583803 -49.9529189044638,-71.9066144858334 -49.953599255992,-71.9064394341333 -49.9545695448099,-71.9066886242165 -49.9555330634033,-71.9072924691613 -49.9562143814542,-71.908050403941 -49.9568282680942,-71.9102712835442 -49.9582741241841,-71.912862539244 -49.9594355134394,-71.9136898818315 -49.9598389564493,-71.9146639395372 -49.9600686903343,-71.9156995582759 -49.9601046309703,-71.9177441252757 -49.9596308611499,-71.9199022544549 -49.959470223645,-71.9209954918337 -49.959449738051,-71.9219992368089 -49.9597299608776,-71.9227244501051 -49.9602581174576,-71.9241650016448 -49.961593955471,-71.92604749829 -49.9626771742912,-71.9282688155284 -49.9634484196987,-71.9336171162248 -49.9683010504154,-71.9349091883374 -49.9701209654881,-71.9372637304093 -49.9714249677976,-71.940248414418 -49.9719735883102,-71.9429544504525 -49.9731214392321,-71.9448216215278 -49.9738510064163,-71.9473015473715 -49.9744367354372,-71.9493461779012 -49.9755148444686,-71.9507290684657 -49.9769659504382,-71.9514953200198 -49.977482458194,-71.9524701624163 -49.9778226801265,-71.9535597846069 -49.9779538748667,-71.9546998710944 -49.9785830064937,-71.955203089087 -49.9794946169762,-71.9537660850879 -49.986630651916,-71.9528788114517 -49.9886033071315,-71.9529211936766 -49.9892949250777,-71.9546627029418 -49.9926645825734,-71.9569776460933 -49.9942192313736,-71.9582771862682 -49.9962047484194,-71.958389328946 -49.9983585484029,-71.9603295645888 -50.000823555303,-71.9606802332274 -50.0019120241071,-71.9607629828573 -50.0060331340215,-71.9601872803555 -50.0068296589453,-71.9602793425565 -50.0077063563651,-71.9608132182003 -50.0082485081422,-71.9616064937489 -50.0086370269944,-71.9625599914218 -50.0088233367342,-71.9632934341156 -50.0087296226989,-71.9640382475666 -50.0087720594695,-71.9647348020469 -50.0089472495615,-71.9654096849065 -50.0093306773999,-71.9658658553368 -50.0098304360846,-71.9659995392301 -50.0106312024741,-71.9657682852839 -50.0114226819104,-71.9651918262091 -50.0121372799471,-71.9641678496046 -50.0125976204129,-71.9629529831265 -50.0127832238043,-71.9620705572016 -50.0129324858885,-71.9612952004063 -50.0132423060054,-71.9606954236773 -50.0136853093174,-71.9602956672886 -50.0146057619318,-71.9606260773075 -50.0155375664263,-71.9619367048642 -50.0167162540824,-71.9638145344329 -50.0175153008701,-71.9660115557316 -50.0178291655969,-71.9668427422509 -50.0182133450887,-71.9674184634278 -50.0187581516699,-71.9676686079541 -50.0193972477265,-71.9671610036781 -50.0214645915084,-71.9674163073622 -50.0220869370818,-71.9680142715321 -50.0227216724347,-71.968903886913 -50.023193697338,-71.9699854653491 -50.0234501142289,-71.9724280608878 -50.0238568548544,-71.9749503656623 -50.0238914848777,-71.9781179562995 -50.0240185111169,-71.981004239963 -50.0235192334878,-71.982954055194 -50.0235019951472,-71.984814305693 -50.0238787577172,-71.9863981069929 -50.0246116716537,-71.9900047115314 -50.0250790464756,-71.9936512714379 -50.0247657180326,-71.9956770085452 -50.0241948449295,-71.9978368387627 -50.023890035047,-71.9988516936235 -50.0237561457466,-71.9998464716662 -50.023942353908,-72.000355776369 -50.0242229068414,-72.0006145176035 -50.0246211361107,-72.0005672868378 -50.0250517721577,-72.0003927495764 -50.0263654656796,-71.9996821416276 -50.0276019395279,-71.9981584961271 -50.0285139103611,-71.9972348029035 -50.0297143410201,-71.9970307924807 -50.031047691076,-71.9990184208201 -50.033961448316,-71.9997587325955 -50.0368590297914,-72.0020099261562 -50.0387129928452,-72.0030994313421 -50.0409595648199,-72.0028866517884 -50.0433091744981,-72.004136975231 -50.0452401453042,-72.0061314545066 -50.0468916272246,-72.0087299179022 -50.0481474985249,-72.0094836619532 -50.0482950464629,-72.0102714516046 -50.0482919271638,-72.011022320698 -50.0481384216224,-72.0123708134491 -50.0481941527336,-72.0136311629801 -50.0485079343971,-72.0145908205084 -50.049240989293,-72.015053363243 -50.0501523152327,-72.0149512096216 -50.0511088159568,-72.0144055055021 -50.0517451969421,-72.0136293077073 -50.0522730855345,-72.0126722511619 -50.0526587207743,-72.0112707141291 -50.0528406814361,-72.0084501456227 -50.0526351161288,-72.0055699612949 -50.0528962954802,-72.0014546875925 -50.0537703805628,-71.9971968278152 -50.0542893315817,-71.9928699986041 -50.0544441757656,-71.9810692422237 -50.0506002585032,-71.9783809496698 -50.0525356567033,-71.9776352458322 -50.053646072987,-71.9773408720822 -50.0548409061992,-71.9775162810549 -50.0560453952806,-71.9774375522615 -50.0571114555476,-71.9772527753396 -50.0576724281556,-71.9767376475691 -50.0581402510779,-71.9759766103854 -50.0584382300607,-71.9749251509316 -50.0584781672292,-71.9738670480547 -50.0582292417611,-71.9727411153821 -50.0582055610799,-71.971660033239 -50.0584094950846,-71.9696535265921 -50.0592809856958,-71.9673909510753 -50.0598345940486,-71.9649917928827 -50.0600410826622,-71.9551507088628 -50.0626090534824,-71.9493419482162 -50.0643588796419,-71.9444072075353 -50.0649201202194,-71.9422644287116 -50.0659855152285,-71.9397792315626 -50.066677287651,-71.9382142917149 -50.0669058135891,-71.9366156151152 -50.0668163331466,-71.9351354500297 -50.0664173679087,-71.9334427734318 -50.0662176997457,-71.9317366157234 -50.0663622038318,-71.9301817863553 -50.06683692154,-71.9278794125238 -50.0681372213808,-71.9266280602017 -50.0694863526827,-71.9245619392739 -50.0703232729192,-71.9224672960715 -50.070559562209,-71.920708765921 -50.0713292135648,-71.9195973280294 -50.0724961310312,-71.918805479286 -50.0750497804126,-71.9199341801577 -50.0775504229728,-71.91971427338 -50.0783337976905,-71.9194943596186 -50.0791171719048,-71.9194210492868 -50.0793782979715,-71.9194801747737 -50.079758841856,-71.9196978674859 -50.0801147033595,-71.920057727093 -50.0804190676037,-71.9209624483128 -50.0811101859449,-71.9220358352321 -50.0816928564842,-71.9227631591263 -50.0823308452571,-71.9229309957665 -50.0831146829405,-71.9226847559908 -50.0836055578248,-71.9221765161027 -50.0840044524081,-71.9214767219606 -50.0842560727125,-71.9203253756923 -50.0844670831826,-71.9194033626781 -50.0849583980643,-71.9188666205962 -50.0856469272115,-71.9188264900376 -50.0870163282485,-71.918448729609 -50.0875972849733,-71.9178187207206 -50.0880792408152,-71.9169938702943 -50.0884182746125,-71.9163736133226 -50.0887930054506,-71.9160922736855 -50.0892877827454,-71.9160777042778 -50.0898145467235,-71.9163315135392 -50.0903154499414,-71.9174496711051 -50.0921056354555,-71.9180271833764 -50.0927755109271,-71.9182188480101 -50.0935315301796,-71.9181114300356 -50.0940285282148,-71.9177308229662 -50.0944665148623,-71.9171289740967 -50.0947857039525,-71.9159837218881 -50.0949395456563,-71.9154409721107 -50.0950620416068,-71.9150092860976 -50.0953065663382,-71.9147517134653 -50.0956374071097,-71.9147345334365 -50.0960062888849,-71.9148799129954 -50.0963632902057,-71.9152865914706 -50.0971998620764,-71.9159108131112 -50.0979790007595,-71.9175828080707 -50.1001883894687,-71.9194840148965 -50.1023197396702,-71.9196336128585 -50.1047788254023,-71.9198683963658 -50.1074870558451,-71.9188123481975 -50.1101130899633,-71.9165651703529 -50.1124085127554,-71.9154420362729 -50.1155334751922,-71.915877304709 -50.1182209755723,-71.9148971855704 -50.1208484941502,-71.9126131397712 -50.1231166493862,-71.9113244881789 -50.1273167530625,-71.9093649405047 -50.1292390722489,-71.9084796451701 -50.1314657884726,-71.9083844149389 -50.1326478472279,-71.9090456534264 -50.1337525454614,-71.910348986608 -50.134588728211,-71.912221654799 -50.1351187526037,-71.9181127051754 -50.1398881297769,-71.9182619634385 -50.1403512106906,-71.9178841501158 -50.1413294679604,-71.917598811527 -50.1420198444219,-71.9176955246515 -50.1427314508671,-71.9181627933602 -50.143379581476,-71.918750931117 -50.1436912794647,-71.9194625372936 -50.1438670143658,-71.9202241363126 -50.1438886407797,-71.9205537391023 -50.143987321338,-71.9207916988695 -50.1441640085241,-71.9208963806711 -50.1443877888974,-71.9209867457126 -50.1450640625578,-71.9205818297384 -50.1456909687514,-71.9197059361522 -50.1474108341579,-71.9191946015521 -50.1478303007186,-71.9189236598501 -50.1483338908947,-71.9189226442956 -50.1488667266129,-71.9194067203291 -50.1496402810575,-71.9203497860763 -50.1502129393577,-71.922500981757 -50.1513597205516,-71.9250022192572 -50.1521614992442,-71.9314191943919 -50.1519425536573,-71.9327890802053 -50.1523139833463,-71.9340029981767 -50.1528656546397,-71.9344232127444 -50.1530545179001,-71.9346609604489 -50.1533464623739,-71.9346644291705 -50.1535873217557,-71.9345439601497 -50.153815416425,-71.9343130566777 -50.15400517636,-71.9337503303955 -50.154173056799,-71.9323079974137 -50.1545627682335,-71.9307620950938 -50.1547181043896,-71.9302974021611 -50.154833191899,-71.9299230468764 -50.1550442230636,-71.9297394416567 -50.155282356426,-71.9296799914413 -50.155545346785,-71.9297505746651 -50.1558071986097,-71.9300608048091 -50.157131524857,-71.9312947731327 -50.158210919427,-71.9328171336543 -50.1587371706354,-71.9339887134904 -50.1595538566816,-71.9346811344454 -50.1605715017223,-71.9344787211558 -50.1625900583878,-71.9327749978023 -50.1656376144265,-71.932618701635 -50.1671002160076,-71.9331231174899 -50.1679009606324,-71.9341101101046 -50.1694375296147,-71.935771286278 -50.1707121129758,-71.9379526870426 -50.1716065461788,-71.9398032772114 -50.1730208640841,-71.9407309326136 -50.1747695754297,-71.9405289063502 -50.1762697016785,-71.9399973496081 -50.1777362229119,-71.9384461005302 -50.1792879896324,-71.9379793663052 -50.1811074649277,-71.9386736849713 -50.1828967510728,-71.9388760025797 -50.1832946942563,-71.9392527280105 -50.1836363397569,-71.9397700891502 -50.1838910572987,-71.9407419178384 -50.1839880523533,-71.9417941007761 -50.1843334429061,-71.9421256459118 -50.1844800898946,-71.9423387837638 -50.1846993957573,-71.9423868951165 -50.1848763665992,-71.9423292124413 -50.1850521540464,-71.9421739844749 -50.1852016168983,-71.9417909915833 -50.1853466982716,-71.9413464373575 -50.1853534959962,-71.9396900265181 -50.1855143344293,-71.9380324007889 -50.1853587411697,-71.9346967957316 -50.1850292049585,-71.9288179443361 -50.1848989311775,-71.927112660625 -50.1850676548589,-71.9256017086477 -50.1856025896931,-71.9247942745285 -50.1861683763685,-71.9243735654143 -50.1868866498322,-71.9244413853564 -50.1875417951682,-71.9247942483522 -50.1881580623567,-71.9254035133123 -50.1886854126427,-71.9258085740572 -50.1897104515887,-71.9256300335179 -50.1907617346259,-71.9248903788148 -50.1917066404154,-71.9233239470544 -50.1924897060723,-71.9214066896235 -50.1928206416766,-71.9206814321991 -50.1927234455606,-71.9200146444852 -50.1925137943508,-71.9192755408783 -50.1924685018873,-71.9186873646243 -50.1925871825046,-71.9181882110145 -50.1928195171247,-71.9178296439586 -50.1931415056938,-71.9171535909094 -50.1938511775702,-71.9166310648963 -50.1944477807807,-71.9164356559958 -50.1951206245845,-71.9165881977779 -50.195798020805,-71.9160345862602 -50.1969851839852,-71.9154856090309 -50.197594859721,-71.9145599077985 -50.1979727442809,-71.91346693894 -50.1980333321879,-71.9122168599109 -50.1984638267231,-71.9113642431814 -50.1991916243125,-71.9156754056018 -50.2075934537546,-71.9168034278359 -50.2087525900599,-71.9174633131194 -50.2089795059964,-71.9182089523784 -50.2090225387953,-71.9187753570678 -50.2088953401498,-71.9192571802352 -50.2086657888713,-71.9196108159609 -50.2083546604852,-71.9198421468226 -50.2079257461521,-71.9202600340033 -50.2075595727317,-71.9208274115601 -50.2072886159746,-71.9218834205009 -50.207191387496,-71.9254497164871 -50.2076982034567,-71.9290997513777 -50.2076086586258,-71.932595340959 -50.2069285962007,-71.9335753137649 -50.2070488684182,-71.9344840633616 -50.20731320778,-71.9352709576791 -50.2077068867444,-71.9373956147421 -50.2080577286186,-71.9395848238579 -50.2079660341901,-71.9414162527806 -50.2073886316,-71.9429801112276 -50.2065474763413,-71.9430161580039 -50.2065426751492,-71.9537426593967 -50.2062656601466,-71.9552603039803 -50.205941188962,-71.9568598855256 -50.2059329288716,-71.958385468252 -50.2062416851227,-71.9598667092531 -50.2070316976631,-71.9602320311343 -50.2075587285208,-71.9608154989662 -50.2079974945581,-71.9613611619925 -50.2082287392693,-71.9619964083547 -50.2083282584916,-71.9624993976042 -50.2082872966486,-71.9629350124939 -50.2081207949262,-71.9632307191915 -50.2078564777527,-71.9636492498826 -50.2073550605653,-71.9640407593261 -50.2067813265476,-71.9646740378625 -50.2063047576066,-71.9654949747119 -50.2059660697387,-71.9669435645421 -50.2058040726631,-71.9678009110796 -50.2059970584366,-71.9684923696119 -50.2063753118136,-71.9689250813581 -50.2068880382109,-71.9690307609065 -50.2077065137887,-71.9687726365238 -50.2085236585117,-71.9689902925671 -50.2093456415129,-71.9696545530966 -50.2100621934682,-71.9711791689675 -50.210644108355,-71.9729309398888 -50.2108233954078,-71.9746619937675 -50.2105746857819,-71.9750634322911 -50.2105211058436,-71.9781652186817 -50.2087824021281,-71.979905847695 -50.2063870864957,-71.9799879893276 -50.2037446145741,-71.981331708202 -50.2009104076117,-71.9825767912279 -50.1980925850177,-71.9837134674025 -50.1957893717821,-71.9846337913164 -50.1938596362132,-71.9852459193669 -50.1918575051459,-71.98874384144 -50.1876065013389,-71.9901922050062 -50.1862079389452,-71.9948772907349 -50.1821421379814,-71.9955141943954 -50.1812386826135,-71.9956737231797 -50.1802522770642,-71.9955046562878 -50.179621018351,-71.9950031011278 -50.1790673571867,-71.9942321563676 -50.1786609364844,-71.9929993147297 -50.1784307069119,-71.9919355632706 -50.1779690375595,-71.991143168026 -50.1773203146312,-71.9907493259202 -50.1767504484579,-71.9907179057682 -50.1761273038452,-71.9909286879759 -50.1757240452431,-71.9913404173492 -50.1753908403899,-71.9919040281338 -50.1751673944342,-71.9925838561776 -50.1751193410656,-71.9932559872049 -50.1752005882575,-71.9938620911703 -50.1754040850917,-71.9944006346117 -50.1758984875501,-71.9945970675515 -50.1764885185369,-71.9944203969705 -50.177081121059,-71.9946504050141 -50.1775569423652,-71.995099535834 -50.1779631888075,-71.9957232077403 -50.1782595311302,-71.996969438337 -50.1783780378649,-71.9981968425932 -50.1781956989527,-71.9992354117129 -50.1777377704513,-72.0013664340729 -50.1759550406575,-72.0069877969926 -50.1737295955412,-72.0085929302607 -50.1732086248944,-72.0103567594936 -50.1729830839011,-72.0114770540458 -50.1729993657536,-72.0125347760466 -50.1732370238048,-72.0134265491352 -50.1736728309108,-72.0139401033905 -50.1741505631344,-72.0141853197776 -50.1747093190069,-72.0141358016804 -50.175288972197,-72.0145043735792 -50.1759877929965,-72.0150831532775 -50.1764007335899,-72.0158404435617 -50.1766693599075,-72.0166929081038 -50.1767641100887,-72.0180786865333 -50.1764557038863,-72.0201160396909 -50.1755439026279,-72.021453693051 -50.1742002951452,-72.0218145828034 -50.1732155419108,-72.022116342408 -50.1722226174084,-72.022358530719 -50.1712229853379,-72.0236674785363 -50.1700527630533,-72.025569479723 -50.1692886816644,-72.0269233979618 -50.1691890639549,-72.0281722439487 -50.1688387233859,-72.0288511323092 -50.1684974475249,-72.0293457977345 -50.1680439509865,-72.0296133401496 -50.1675175686349,-72.0296319530103 -50.1667224892343,-72.0292600919937 -50.165964042759,-72.0276726699645 -50.1639617350936,-72.0250783221331 -50.1624545442703,-72.0225104367136 -50.16084868189,-72.0206998153152 -50.1588619795045,-72.0197767441641 -50.1566375027168,-72.019872250134 -50.155790711932,-72.0202144232037 -50.1554291654178,-72.0207211460666 -50.1551588776856,-72.0212396104092 -50.1550464429892,-72.0217865940811 -50.1550365238084,-72.0223141037743 -50.1551299904696,-72.0237830890554 -50.1557322652162,-72.0258521478086 -50.1571799944274,-72.0282935015783 -50.1583644529303,-72.0310272110763 -50.1592468453682,-72.0332282479852 -50.1605005493609,-72.0346121814669 -50.1617922642801,-72.0352495957468 -50.1633059555713,-72.0350680256123 -50.1648697067254,-72.0341299782665 -50.165832603487,-72.0339979605985 -50.1669653197396,-72.03450629567 -50.1677287175093,-72.0353828430585 -50.1683389644418,-72.036526668834 -50.1687257828874,-72.0384980911759 -50.1688678526146,-72.0402387782567 -50.1694790455937,-72.0414892228737 -50.1704682476791,-72.043492393976 -50.1755677258597,-72.0442062964834 -50.1797484531286,-72.046017473993 -50.1826776148894,-72.0585848990501 -50.1852626951704,-72.0593008585478 -50.185352442661,-72.0615907364052 -50.1857108510772,-72.0639305358077 -50.1855286875086,-72.0660206315468 -50.1848292791479,-72.0662469655604 -50.1846759279657,-72.0663830176994 -50.1844835617346,-72.0664139071052 -50.1842732223334,-72.0662718690777 -50.1840569327169,-72.0660050493487 -50.1838964733368,-72.0657432294281 -50.1838552248765,-72.0654746521908 -50.1838701834694,-72.0652278037952 -50.1839397625598,-72.064891278627 -50.1839449374213,-72.0645802193101 -50.183862318838,-72.0642007282397 -50.1836132326447,-72.064040180787 -50.1832803783081,-72.0641546778022 -50.1827651417168,-72.0646317177145 -50.1823443735472,-72.0667607642713 -50.1815828596812,-72.0677277118173 -50.1814169130451,-72.0684869927908 -50.1809981689879,-72.0687845893214 -50.1805590888848,-72.0688095735612 -50.1800804947492,-72.0685497222905 -50.1796890014822,-72.0681238687598 -50.1793629216962,-72.0675687960481 -50.1791304182914,-72.0656021951438 -50.1786676833165,-72.0639921391625 -50.1787426996266,-72.0624207999196 -50.1785051754614,-72.0610319207291 -50.1779768393019,-72.0591011188725 -50.1766921347474,-72.0579392210713 -50.175070063223,-72.0579718320199 -50.173575269604,-72.0586246746287 -50.1721403311681,-72.0594016191276 -50.1714544412237,-72.0598197277866 -50.1706498713075,-72.0598399670569 -50.1698017695037,-72.0601281951813 -50.1687502669817,-72.0603256450882 -50.1682258873899,-72.0607976455455 -50.1677796300288,-72.0614838627078 -50.1674685319517,-72.0621244920278 -50.1674271954838,-72.0627431416732 -50.1675417743746,-72.0631687774032 -50.1677785548426,-72.063471904553 -50.1680833487851,-72.063627451867 -50.1684309495977,-72.0634015594255 -50.1694452271258,-72.0625443323735 -50.1702582315664,-72.0621836370196 -50.1712124066098,-72.062365010703 -50.1721873674303,-72.0634701938841 -50.1740174499873,-72.064526464364 -50.1749229750895,-72.0660701337714 -50.1754682694216,-72.0673579939435 -50.175536552651,-72.0686151488855 -50.1753444836731,-72.0697171551587 -50.1749110751896,-72.0710538252663 -50.1738370267848,-72.0716171621023 -50.17251052584,-72.0738743138485 -50.1708105041014,-72.0762373163518 -50.1695980459308,-72.0780093696367 -50.1684031188088,-72.0819357809503 -50.1646763988887,-72.0825950769948 -50.1627542647777,-72.0822366373743 -50.1607995412973,-72.0809002225448 -50.1590284180479,-72.0800220330368 -50.15704276699,-72.0798959184183 -50.1557867496823,-72.0804265795524 -50.1545751786081,-72.0815536664099 -50.1535457367389,-72.083519481964 -50.1528651269144,-72.0857250627801 -50.152640831241,-72.0879219013746 -50.1528981214511,-72.0910473962203 -50.1535098070319,-72.0959631002119 -50.1543052285277,-72.0984340994445 -50.1539893422166,-72.1004839048079 -50.1530481884317,-72.1015329071369 -50.1519610124653,-72.103154394264 -50.1512188748547,-72.1042567893347 -50.1511218891066,-72.105246356434 -50.1507950108639,-72.1060106020686 -50.1502754005564,-72.1074370773592 -50.1485562692564,-72.1083396923306 -50.1473286086216,-72.1085203610398 -50.1459758054363,-72.1079565182025 -50.1446672682514,-72.1081084886131 -50.1423721491675,-72.109718268836 -50.140194746426,-72.1124238022006 -50.1385250633674,-72.1158741100303 -50.1375796453535,-72.1187596687237 -50.1374282489145,-72.1217466288746 -50.1379615006989,-72.1248413048344 -50.1378441032487,-72.1258770689232 -50.1378084091919,-72.1264306410691 -50.1376180258895,-72.1268673275546 -50.1373280970925,-72.1271454207831 -50.1369663152781,-72.1271633684398 -50.1364147065813,-72.1268114378818 -50.135911478098,-72.1257176665101 -50.1342721438664,-72.1238619197171 -50.1329459353441,-72.1214413460643 -50.1320737070627,-72.1181769810884 -50.131866031361,-72.1150122585089 -50.1324208750234,-72.1124114892988 -50.1335429276639,-72.1105391018677 -50.1342786275436,-72.0971960871171 -50.1356605112594,-72.0936130853958 -50.1347150465525,-72.0903759179934 -50.1333482515694,-72.0876030926086 -50.1316101766683,-72.0863204120573 -50.1295367627114,-72.0861425171634 -50.1281280106991,-72.0865951945126 -50.1259201462977,-72.0869798255584 -50.1227457220374,-72.0876712235773 -50.1211093083039,-72.0889222280783 -50.1195206965229,-72.0933147525737 -50.1171628449893,-72.1039001840462 -50.115800962944,-72.1071861418678 -50.1161139501914,-72.1162937141598 -50.1179116719187,-72.1198984195414 -50.1179080840751,-72.1232359738061 -50.1187837893329,-72.1247703334048 -50.1198584950115,-72.1267617884887 -50.1205576312823,-72.1289975386305 -50.1208064857168,-72.1339239538304 -50.1232835299637,-72.1361417056297 -50.1239505044301,-72.1377260399476 -50.1251506405845,-72.1383890996715 -50.1266659273034,-72.1389123067448 -50.127717955687,-72.1398498692357 -50.1286435014196,-72.1411349812961 -50.1293765937634,-72.1543627655292 -50.1350368490713,-72.1554060741407 -50.1377766062228,-72.15802746874 -50.1400387849532,-72.1618130140504 -50.1414660149268,-72.1632235239799 -50.1423406337478,-72.1650834557873 -50.1443352059246,-72.170258723644 -50.1465760208971,-72.172847999824 -50.1468893129121,-72.1750551869133 -50.1478139601787,-72.1765460668564 -50.149209962465,-72.1775216410109 -50.150281677957,-72.182179578021 -50.1566964132474,-72.182397001905 -50.1569154371454,-72.1841064572471 -50.1586132977654,-72.1988804865069 -50.1601618553901,-72.2066095107334 -50.1611706155363,-72.2210647793927 -50.1617478495183,-72.2277128939152 -50.1637907515638,-72.2308396976939 -50.1640847623019,-72.2348004863498 -50.1651982641894,-72.2424027513486 -50.1660979370984,-72.2476997827188 -50.1662024876546,-72.2530283030323 -50.1662026170318,-72.2693178434437 -50.1666212920389,-72.2791429494459 -50.167020478468,-72.2857203539495 -50.1670715373585,-72.344509179455 -50.1678328703906,-72.3500763012802 -50.1670434589884,-72.3556146597358 -50.1670244082683,-72.3709407606721 -50.1664359355701,-72.374700278495 -50.1662305878713,-72.382804219639 -50.1662009246329,-72.3894741962771 -50.1655979921536,-72.399563815204 -50.164544505719,-72.4178070117841 -50.1645383209867,-72.4290222393848 -50.163704912052,-72.4508778648703 -50.1636383615242,-72.454045624406 -50.1637067790446,-72.4677939697159 -50.1637005233604,-72.4744297778807 -50.164770995017,-72.4837592050233 -50.1642038298428,-72.4877075516621 -50.1637034740361,-72.4926079682831 -50.1636808668785,-72.499320874059 -50.1633070807571,-72.5072317540757 -50.163009729769,-72.5086285325807 -50.1631096741721,-72.5117418578005 -50.1637065371269,-72.5257630421307 -50.1637135536375,-72.5300359442034 -50.1645320967788,-72.5420341198108 -50.1648916191964,-72.5511179181573 -50.1643816968578,-72.554712950842 -50.1648706564556,-72.5655802154072 -50.1643177084905,-72.5689397318831 -50.164108099709,-72.5756518705373 -50.1637299069096,-72.5809778913166 -50.1637012644018,-72.5850500665073 -50.1631817485388,-72.5889859080732 -50.1637157731644,-72.5914755372931 -50.1634009450172,-72.5939623812701 -50.1637247284629,-72.5954821251795 -50.1643679407133,-72.5966052650753 -50.1652878586124,-72.5972155182674 -50.1663892602255,-72.5968876240646 -50.168278969199,-72.5974584632605 -50.1696095225696,-72.5972244626477 -50.1709814606817,-72.5962185976804 -50.1722010709795,-72.5940992874006 -50.1731588340638,-72.5931565863645 -50.1733200861594,-72.5921880750891 -50.1733953024058,-72.5912126954781 -50.1733830117209,-72.5871557997091 -50.1722508474327,-72.5846582087408 -50.1714165116357,-72.5836579477992 -50.1713583257648,-72.5827311749027 -50.1716069283855,-72.5822611830668 -50.1719691457039,-72.5820076491446 -50.1724116431998,-72.5819999703498 -50.1728831241243,-72.5825500858439 -50.173579226966,-72.5841270086515 -50.1744821164628,-72.5861093539648 -50.1749512394933,-72.5882214994054 -50.1749213684344,-72.5904971313733 -50.1754414517115,-72.5932780827906 -50.1758477512492,-72.6021252096897 -50.1782172734003,-72.6055765787168 -50.1789991170115,-72.6108150222359 -50.1805506488201,-72.6143981744774 -50.1814449889718,-72.6146604220408 -50.181494986904,-72.6152513791478 -50.181607651272,-72.6203502540219 -50.1815785558215,-72.6234288466615 -50.1807471154713,-72.6283326489817 -50.1769517324991,-72.6291263802384 -50.17662235117,-72.6374115530176 -50.1762145855196,-72.6430326693016 -50.1776429753535,-72.6461034425311 -50.1778589333999,-72.6484541710232 -50.1785893619095,-72.6513128348328 -50.1803857301651,-72.6588878927227 -50.1820926298222,-72.6612273210018 -50.1828474777991,-72.6656408988947 -50.185345329338,-72.6710131388061 -50.187930504743,-72.673903965766 -50.189174105801,-72.6757720479255 -50.1914387340503,-72.6786050581795 -50.1932440328107,-72.6821465085888 -50.1944265012358,-72.7032733778641 -50.1949711874703,-72.7051132749035 -50.1951911440372,-72.7078557463585 -50.1954864049989,-72.7090951338579 -50.1960833003021,-72.709973336122 -50.1969027323954,-72.7103986465535 -50.1978591504027,-72.7112634889874 -50.1984502087819,-72.712365090943 -50.1988471037052,-72.7136015999744 -50.1990131373774,-72.7172804794073 -50.1987151598825,-72.720867347076 -50.1993187113175,-72.7238454488084 -50.2007368400331,-72.7257827396563 -50.2011899778349,-72.7278425679868 -50.2011303433173,-72.729708431018 -50.2005670998787,-72.7334807505134 -50.2003157695303,-72.735283472657 -50.2003275204755,-72.7369938626602 -50.2006932925239,-72.7384473540666 -50.2013778932396,-72.7389411571016 -50.2018666420145,-72.7396389092605 -50.2022391488251,-72.7402362530769 -50.2024033526549,-72.7408843885899 -50.2024333958554,-72.741512294284 -50.2023259863715,-72.7422872101866 -50.2018654397382,-72.7440276507996 -50.2010893864319,-72.7461081995365 -50.2008308714187,-72.7477455521242 -50.2010424834198,-72.7493873945927 -50.2008457251463,-72.7504698519306 -50.2003880149226,-72.7512715993641 -50.1997342541174,-72.7517105345152 -50.1989514010671,-72.7532983434481 -50.1979302905332,-72.7553494882536 -50.1973404639842,-72.7579799091203 -50.1954803984331,-72.7580500260878 -50.1954325630623,-72.7617546244359 -50.1941118316975,-72.7632439520407 -50.1939229150729,-72.7647303570373 -50.1941210904493,-72.7659793449171 -50.1946750937746,-72.7688972872773 -50.1948824512594,-72.7708399056093 -50.1945982078859,-72.7724365752585 -50.1938331272983,-72.7731981577807 -50.1928667479756,-72.7734690005054 -50.1917977809719,-72.7732237888265 -50.19072626749,-72.7741142479742 -50.1880178506432,-72.775195862599 -50.1868724327165,-72.7763041780953 -50.1861158294819,-72.7802827788272 -50.184013415087,-72.7821959256147 -50.1825976317759,-72.7845835733817 -50.1815754573805,-72.7871885421657 -50.1808025605436,-72.789948217614 -50.1802975162208,-72.7912067498523 -50.1803433736572,-72.7924652819226 -50.1803892448467,-72.7961327209962 -50.1809814231514,-72.7978139212708 -50.1813478558143,-72.7992616264733 -50.1820078066845,-72.8003548241314 -50.1829061161466,-72.8011421413587 -50.1838077920857,-72.8019225401361 -50.1847119493559,-72.8026667813469 -50.1874861004032,-72.801724446526 -50.1895999361881,-72.8019123160812 -50.1906910468582,-72.802719797215 -50.19165868884,-72.8040306743906 -50.1923635571346,-72.8054378395627 -50.1926974748199,-72.8135820931391 -50.1936880257817,-72.8167253447854 -50.1934690278841,-72.819561774823 -50.1925723721875,-72.8217485002931 -50.1911064597952,-72.8233415367182 -50.1906481354877,-72.8247655381803 -50.1907122019856,-72.82597)';

		var format = new ol.format.WKT();

		var feature = format.readFeature(wkt, {
			dataProjection: 'EPSG:4326',
			featureProjection: 'EPSG:3857'
		});

		var vector = new VectorLayer({
			source: new VectorSource({
				features: [feature]
			})
		});
		
		
		var layer_873 = new ol.layer.Tile({
			name:"ahrsc:vp_geo_limites_provinciales_sit_pga",
			visible:true,
			source: new ol.source.TileWMS({
				url: "http://observatorio.ieasa.com.ar/geoserver/ows?",
				params: {
					'LAYERS': "ahrsc:vp_geo_limites_provinciales_sit_pga",
					'VERSION': '1.1.1',
					'FORMAT': 'image/png',
					'TILED': false,
					'clase_id':-1,
					'layer_id':873
				}/*,
				crossOrigin: 'anonymous'*/
			})
		});
		
		var layer_874 = new ol.layer.Tile({
			name:"ahrsc:polig_rscruz_pga",
			visible:true,
			source: new ol.source.TileWMS({
				url: "http://observatorio.ieasa.com.ar/geoserver/ows?",
				params: {
					'LAYERS': "ahrsc:polig_rscruz_pga",
					'VERSION': '1.1.1',
					'FORMAT': 'image/png',
					'TILED': false,
					'clase_id':-1,
					'layer_id':874
				}/*,
				crossOrigin: 'anonymous'*/
			})
		});
		
		var layer_875 = new ol.layer.Tile({
			name:"ahrsc:polig_obra_pga",
			visible:true,
			source: new ol.source.TileWMS({
				url: "http://observatorio.ieasa.com.ar/geoserver/ows?",
				params: {
					'LAYERS': "ahrsc:polig_obra_pga",
					'VERSION': '1.1.1',
					'FORMAT': 'image/png',
					'TILED': false,
					'clase_id':-1,
					'layer_id':875
				}/*,
				crossOrigin: 'anonymous'*/
			})
		});
		
		
		this.baselayers.collection = [this.baselayers.openstreets,this.baselayers.opentopo,this.baselayers.bing_roads,this.baselayers.bing_aerials,this.baselayers.google,this.baselayers.argenmap,layer_872,layer_873,layer_874,layer_875,vector];
		
		
		///////document.getElementById("baselayer-default-radio").click();
		
		this.ol_object = new ol.Map({
			interactions: ol.interaction.defaults({
				doubleClickZoom: false,
				dragAndDrop: false,
				dragPan: false,
				keyboardPan: false,
				keyboardZoom: false,
				mouseWheelZoom: false,
				pointer: false,
				select: false
			}),
			layers:this.baselayers.collection,
			target: 'map',
			extent: [-8743435.457752563,-7463770.851212183,-6782265.669620513,-5626227.81190221],
			controls: [],
			view: new ol.View({
				center: [-7176058.888636417,-4680928.505993671],
				zoom:5.8,
				minZoom: 5.8,
				maxZoom: 5.8
			})
		});
		
		layer_874.setZIndex(500);
		layer_875.setZIndex(400);
		layer_872.setZIndex(300);
		layer_873.setZIndex(200);
		
		/*var js = {
			
			minx:-8758221.51045902,
			miny:-7304514.551140834,
			maxx:-6797051.72232697,
			maxy:-5466971.511830861,
			
		}*/
		
		var js = {
			
			minx:-8743435.457752563,
			miny:-7463770.851212183,
			maxx:-6782265.669620513,
			maxy:-5626227.81190221
			
		}
		
		var extent = ol.proj.transformExtent(
			[js.minx,js.miny,js.maxx,js.maxy],
			"EPSG:3857", "EPSG:3857"
		);
				
		this.ol_object.getView().fit(extent,{duration:1000});
		this.ol_object.updateSize();
		this.ol_object.render();
		
		this.baseLayer = this.baselayers.bing_aerials;
		
		this.ol_object.infoEnabled = true;
		this.ol_object.map_object = this;
		
		this.ol_object.addEventListener("click",function(evt) {
			
			$("#popup-results").empty();
			$("#popup-results-preparse").empty();
			
			if (this.infoEnabled ) {
			
				var pos = evt.coordinate;
								
				/*console.log("POS: " + pos);
				
				var coord = String(pos).split(",");
				
				document.getElementById("global-coordinates-fixed-span").innerHTML = "Último Click: EPSG:3857 | " + coord[1] + ", " + coord[0];
				
				var iconFeature = new ol.Feature({
				  geometry: new ol.geom.Point(pos)
				});

			
				var iconStyle = new ol.style.Style({
					image: new ol.style.Icon( ({
					anchor: [0.5, 26],
					anchorXUnits: 'fraction',
					anchorYUnits: 'pixels',
					opacity: 0.95,
					src: './images/map-marker.png'
					}))
				});

				iconFeature.setStyle(iconStyle);
				
				if (!this.map_object.markersLayer) {

					this.map_object.markersLayer = new ol.layer.Vector({
						visible:true,
						source: new ol.source.Vector({
							features: [iconFeature]
						})
					});
					
					this.map_object.ol_object.addLayer(this.map_object.markersLayer);
					
				}else{
					
					this.map_object.markersLayer.getSource().clear();
					this.map_object.markersLayer.getSource().addFeature(iconFeature);
					
				}*/
			
				$("#info-wrapper").empty();
				
				this.map_object.gfiAddedLayers = [];
				
				var view = this.getView();
				var map = this.map_object;
				
				var viewResolution = (view.getResolution());
				var url = '';
				
				var ii = 0;
				
				this.getLayers().forEach(function (layer, i, layers) {	
				
					var baselayer_names = ["openstreets","opentopo","bing","bing_roads","bing_aerials","google_base"];
					var isBase = false;
					
					for (var i=0; i<baselayer_names.length; i++) {
						
						if (layer.get('name') == baselayer_names[i]) {
							
							isBase = true;
							break;
							
						}
						
					}
					
					// alert("LAYER: " + layer.get('name') + " - VISIBLE: " + layer.getVisible() + " - ISBASE: " + isBase);
					
					if ((layer.getVisible()) && (isBase == false)) {
						
						if(layer.getSource().getGetFeatureInfoUrl) {	
						
							url = layer.getSource().getGetFeatureInfoUrl(evt.coordinate, viewResolution, 'EPSG:3857', {
								'INFO_FORMAT': 'text/html',
									'FEATURE_COUNT': '300'
							});	
							
							var req = $.ajax({
								
								async:false,
								type:"GET",
								url:url,
								//url:"urldeprueba.php",
								success:function(d){}
								
							})
							
							if (req.responseText != "") {
							
								var html = req.responseText;
									html = html.split("body>");
								
								if (html.length > 0) {
								
									html = html[1].substring(0,html[1].length-2);
									html = html.trim();
									
									map.preparseGFI(html,"popup-info","info-wrapper"); // PARA ACOMODAR RESPUESTA A ESTRUCTURA DE IEASA
									
								
								}
							
							}
							
							//map.parseGFI(req.responseText,"popup-info","info-wrapper");
						
							scroll.refresh();
						
						}
						
						map.gfiAddedLayers.push(layer.layer_id);
					
					}
					
					if (ii==(layers.length-1)) {
	
						map.parseGFI();
						
					}
					
					ii++;
					
				});
			
			}
			
		});		
		
		this.global_mouse_position_3857 = new ol.control.MousePosition({
			coordinateFormat: function(coordinate) {
			  return "EPSG:3875 | " + ol.coordinate.format(coordinate, '{y}, {x}', 4);
			},
			projection: 'EPSG:3857',
			className: 'custom-mouse-position',
			target: document.getElementById('global-coordinates-span')
		});
		
		this.ol_object.addControl(this.global_mouse_position_3857);
		
		this.createLayers = function() {
			
			//
			
		}
		
		this.createPrintLegendDiv = function() {
			
			var div = document.createElement("div");
				div.id = "print-legend-wrapper";
			
			document.getElementById("map").appendChild(div);
			
		}		
		
	}
	
	this.map.startSearch = function() {
		
		$("#panel-seach-input-layers-bottom").val("");
		
		$("#panel-seach-input-layers-bottom").bind("focus",function() {
			
			$(this).parent().animate({
				
				"background-color":"#31cbfd"
				
			},"fast");
			
		});
		
		$("#panel-seach-input-layers-bottom").bind("blur",function() {
			
			$(this).parent().animate({
				
				"background-color":"#4c4b4b"
				
			},"fast");
			
		});
		
		$("#panel-seach-input-layers-bottom").bind("keyup",function(e) {
			
			if ($("#panel-seach-input-layers-bottom").val().trim() == "") {
				
				$("#panel-busqueda-geovisor").hide();
				
			}else{
				
				if (e.which == 13) {
					
					this.searchInLayers($("#panel-seach-input-layers-bottom").val());				
					$("#panel-busqueda-geovisor").css("display","flex");
					
				}
				
			}
			
		}.bind(this));
		
	}
	
	this.map.searchGlobal = function() {
		
		var pattern = $("#main-search").val();
		var url = "./mediateca.php?s="+pattern;
		var flink = document.createElement("a");
			flink.href = url;
			flink.target = "_blank";
			document.body.appendChild(flink);
			flink.click();
			$(flink).remove();
		
	}
	
	this.map.searchInLayers = function(pattern) {
		
		$("#panel-busqueda-geovisor").css("display","flex");
		$("#panel-busqueda-geovisor .panel-header").html("Resultados de Búsqueda");
		
		var req = $.ajax({
			
			async:false,
			url:"./php/get-layers-search.php",
			type:"post",
			data:{
				pattern:pattern
			},
			success:function(d){}
			
		});		
		
		$("#panel-busqueda-geovisor .panel-body").html(req.responseText);
		
		scroll.refresh();
		
	}
	
	this.map.setBaseLayer = function(layerObj) {
		
		for (var i=0; i<this.baselayers.collection.length; i++) {
				
			this.baselayers.collection[i].setVisible(false);
		
		}
		
		layerObj.setVisible(true);
		this.baseLayer = layerObj;
		
	}	
	
	this.map.getBaseLayer = function() {
		
		return this.baseLayer;
		
	}
	
	this.map.activateClases = function(arrid) {
		
		for (var i=0; i<arrid.length; i++) {
			
			$(".panel-abr[data-cid="+arrid[i]+"]").attr("data-active",1);
			$(".panel-abr[data-cid="+arrid[i]+"]").show();
			
		}
		
	}
	
	this.map.updateLayerCount = function() {
		
		var count = $(".layer-checkbox[data-added=1]").length;
		$(".layers-visible-count").html("("+count+")");
		
	}
	
	this.map.panel = this.panel;
	
	this.map.loadGeovisor = function(geovid) {
		
		var req = $.ajax({
			
			async:false,
			type:"POST",
			url:"./php/get-geovisor.php",
			data:{geovid:geovid},
			success:function(d){}
			
		});
		
		this.geovisor = geovid;
		
		var js = JSON.parse(req.responseText);
		
		$("#navbar-tools h3").html(js.geovisor_desc);
		
		var panel = this.panel;
		
		for (var i=0; i<js.data.length; i++) {
			
			//if (js.data[i].iniciar_panel == "t") {
				
				if (js.data[i].iniciar_panel == "t") { js.data[i].iniciar_panel = true; } else { js.data[i].iniciar_panel = false; }
				if (js.data[i].iniciar_visible == "t") { js.data[i].iniciar_visible = true; } else { js.data[i].iniciar_visible = false; }
				
				var cid = $(".layer-checkbox[data-lid="+js.data[i].layer_id+"]").attr("data-cid");
				
				var lid = $(".layer-checkbox[data-lid="+js.data[i].layer_id+"]").attr("data-lid");
					
				panel.AddLayer(cid,lid,js.data[i].iniciar_panel,js.data[i].iniciar_visible);
				
				if (js.data[i].iniciar_visible) {
					
					$(".layer-checkbox[data-lid="+js.data[i].layer_id+"]").prop("checked",true);
					
				}
				
			//}
			
		}
		
		var array_geovisor = [ parseFloat(js.minx), parseFloat(js.maxx), parseFloat(js.miny), parseFloat(js.maxy) ];
		
		this.ol_object.getView().fit(array_geovisor,{size:this.ol_object.getSize()});
		//this.ol_object.getView().fit([ -8149293.741521936, -6378849.225655933, -7812129.881098088, -6226949.882287896 ],{size:this.ol_object.getSize()});
		this.ol_object.updateSize();
		this.ol_object.render();
		
	}
	
	this.map.preparseGFI = function(response,containerID,wrapperID) {
		
		document.getElementById("popup-results-preparse").innerHTML += response;
		
		var newnodes = "";
		
		$("#popup-results-preparse table[class=featureInfo] tbody").children("tr").each(function(i,v) {
			
			if ($(v).children("th").length == 0) {
			
				var node = $(v).children("td").first();
				var val = $(node).text().split(".");
				
				var gid = $(v).children("td:nth-child(2)");
					gid = $(gid).text();
				
				var newnode = "<img src=\"../img/t.gif\" x=\"" + gid + "\" y=\"" + val[0] + "\" z=\"1\" />";
				
				newnodes += newnode;
			
			}
			
		});
		
		document.getElementById("popup-results").innerHTML += newnodes;
	
	}
	
	this.map.parseGFI = function() {
		
		var results = [];
		
		var entered = false;
		
		$("#popup-results").children().each(function(i,v) {
			
			var gid = $(v).attr("x");
			var layer_name = "ahrsc:"+$(v).attr("y");
			
			results.push(layer_name + ";" + gid);
			
			entered = true;
			
		});
		
		if (entered) {
			
			$("#map-details").empty();
			
			var req = $.ajax({
				
				async:false,
				type:"POST",
				data:{
					results:results
				},
				url:"./php/get-layer-info-pdga.php",
				success:function(d) {}
				
			});
			
			document.getElementById("map-details").innerHTML = req.responseText;
			
			scroll.refresh();
	
		}
		
		//$("#popup-results").empty();
		
	}
	
	this.map.parseGFIbuffer = function(response,containerID,wrapperID) {
		
		document.getElementById(wrapperID).innerHTML = "";
		
		document.getElementById("popup-results-buffer").innerHTML = response;
		
		var results = [];
		
		var entered = false;
		
		$("#popup-results-buffer").children().each(function(i,v) {
			
			var gid = $(v).attr("x");
			var layer_name = $(v).attr("y");
			
			results.push(layer_name + ";" + gid);
			
			entered = true;
			
		});
		
		if (entered) {
			
			jwindow.close("popup-info");
			
			$("#info-wrapper").empty();
		
			var req = $.ajax({
				
				async:false,
				type:"POST",
				data:{
					results:results
				},
				url:"./php/get-layer-info-pdga.php",
				success:function(d) {}
				
			});
			
			document.getElementById(wrapperID).innerHTML = req.responseText;
					
			jwindow.open(containerID);
			
			scroll.refresh();
			
			$("[title]").tooltipster({
				animation: 'fade',
				delay: 200,
				theme: 'tooltipster-default',
				trigger: 'hover'
			});
	
		}
		
	}
	
	this.map.zoomToLayerExtent = function(layer_id) {
		
		var js = this.getLayerExtent(layer_id);
		
		var extent = ol.proj.transformExtent(
			[js.minx,js.miny,js.maxx,js.maxy],
			"EPSG:3857", "EPSG:3857"
		);
		
		this.ol_object.getView().fit(extent,{duration:1000});
		this.ol_object.updateSize();
		this.ol_object.render();
		
	}
	
	this.map.getLayerExtent = function(layer_id) {
		
		var reqExtent = $.ajax({
			
			async:false,
			url:"./php/get-layer-extent.php",
			type:"post",
			data:{layer_id:layer_id},
			success:function(d){}
				
		});
		
		var js = JSON.parse(reqExtent.responseText);
		
		return js;
		
	}
	
	this.map.getLayerData = function(layer_id) {
		
		var reqExtent = $.ajax({
			
			async:false,
			url:"./php/get-layer-data.php",
			type:"post",
			data:{layer_id:layer_id},
			success:function(d){}
				
		});
		
		var js = JSON.parse(reqExtent.responseText);
		
		return js;
		
	}
	
	this.map.setupTools = function() {
		
		$(".toggleable-tool").each(function(i,v) {
			
			$(v).bind("click",function() {
				
				if ($(v).closest("#dropdown-draw").length == 0) {
					
					if ((this.drawing) && (this.drawing.source)) {
						
						this.drawing.source.clear();
						
					}
					
				}
				
				
			}.bind(this));
			
		}.bind(this));
		
	}
	
	this.map.disableTools = function() {			
			
		if (this.deleteSelect) { this.ol_object.removeInteraction(this.deleteSelect); }
		if (this.select) { this.ol_object.removeInteraction(this.select); }
		if (this.modify) { this.ol_object.removeInteraction(this.modify); }
		if (this.draw) { this.ol_object.removeInteraction(this.draw); }
		if (this.medi_draw) { this.ol_object.removeInteraction(this.medi_draw); }
		if (this.bufferdraw) { this.ol_object.removeInteraction(this.bufferdraw); }
		if (this.ptopo_draw) { this.ol_object.removeInteraction(this.ptopo_draw); }
		
		if ((this.drawing) && (this.drawing.source)) {
			
			var vectorLayer = this.drawing;
			var source = this.drawing.source;
			var features = this.drawing.source.getFeatures();
				
				features.forEach((feature) => {
					source.removeFeature(feature);
				});			
						
			this.drawing.source.clear();
		}
		
		if ((this.buffer) && (this.buffer.source)) {
			
			var vectorLayer = this.buffer;
			var source = this.buffer.source;
			var features = this.buffer.source.getFeatures();
				
				features.forEach((feature) => {
					source.removeFeature(feature);
				});			
						
			this.buffer.source.clear();
			
		}
		
		if ((this.medicion) && (this.medicion.source)) {
			
			var vectorLayer = this.medicion;
			var source = this.medicion.source;
			var features = this.medicion.source.getFeatures();
				
				features.forEach((feature) => {
					source.removeFeature(feature);
				});			
						
			this.medicion.source.clear();
			
		}
		
		if ((this.ptopografico) && (this.ptopografico.source)) {
			
			var vectorLayer = this.ptopografico;
			var source = this.ptopografico.source;
			var features = this.ptopografico.source.getFeatures();
				
				features.forEach((feature) => {
					source.removeFeature(feature);
				});			
						
			this.ptopografico.source.clear();
			
		}
		
		this.ol_object.infoEnabled = true;
		
		$(".toggleable-tool-active").removeClass("toggleable-tool-active");
		
		if (this.markersLayer) {
		
			this.markersLayer.getSource().clear();
		
		}
		
	}
	
	this.map.setupDisableTools = function() {
		
		$("body").on("keyup",function(event) {
			
			if (event.which == 27) {				
			
				this.disableTools();
				
			}
			
		}.bind(this));
		
	}
	
	this.map.share = function() {
		
		var s_layers = [];
		var s_visibles = [];
		var s_clase = [];
		var clase_active = $(".panel-abr[data-active=1]").attr("data-cid");
		
		if (clase_active == undefined) {
			
			clase_active = "";
			
		}
		
		var zoom = this.ol_object.getView().getZoom();
		var center = this.ol_object.getView().getCenter();
		
		$(".panel-abr:visible").each(function(i,v) {
			
			s_clase.push(this.getAttribute("data-cid"));
			
		});
		
		$(".layer-checkbox[data-added=1]").each(function(i,v) {
			
			if (v.layer) {
								
				var visible = 0;
				
				if (v.layer.getVisible()) { visible = 1; }
				
				s_layers.push(v.getAttribute("data-lid"));
				s_visibles.push(visible);
				s_clase.push(v.getAttribute("data-cid"));
				
			}
			
		});
		
		var s_link = SITEURL+"geovisor.php?";
			s_link += "fk=0";
			s_link += "&c=" + s_clase.join(",");
			s_link += "&ca=" + clase_active;
			s_link += "&l=" + s_layers.join(",");
			s_link += "&v=" + s_visibles.join(",");
			s_link += "&cen=" + center;
			s_link += "&z=" + zoom;
		
		$("#input-share").val(s_link);
		
		$(".popup").not("#popup-busqueda").hide();
		$("#popup-share").show();
		
	}
	
	this.map.print = function() {					
			
		$("#print-legend-wrapper").empty();
		$("#print-legend-wrapper").show();
			
		$(".layer-checkbox[data-added=1]:checked").each(function(i,v) {
			
			var src = $(v).parent().parent().next(".layer-body").children(".layer-legend").children("img").attr("src");
			var newImage = document.createElement("img");
				newImage.setAttribute("src",src);
			
			$("#print-legend-wrapper").append(newImage);
			
			//$(v).parent().parent().next(".layer-body").children(".layer-legend").clone().appendTo("#print-legend-wrapper");
			
		});/*
		
		this.ol_object.once('rendercomplete', function(event) {
			
			var canvas = event.context.canvas;
			
			if (navigator.msSaveBlob) {
				navigator.msSaveBlob(canvas.msToBlob(), 'map.png');
			} else {
				canvas.toBlob(function(blob) {
					saveAs(blob, 'map.png');
				});
			}
        });
		
        this.ol_object.renderSync();*/

		/*html2canvas(document.querySelector("#map")).then(canvas => {
			
			var a = document.createElement('a');
			// toDataURL defaults to png, so we need to request a jpeg, then convert for file download.
			a.href = canvas.toDataURL();
			a.download = 'captura.png';
			
			document.body.appendChild(a);
			
			a.click();
			
			$(a).remove();
			
			$("#print-legend-wrapper").hide();
			
		});*/
		
		var node = document.getElementById('map');

		domtoimage.toPng(node)
			.then(function (dataUrl) {
				var img = new Image();
				img.crossOrigin = "Anonymous";
				img.src = dataUrl;
				document.body.appendChild(img);
			})
			.catch(function (error) {
				console.error('oops, something went wrong!', error);
			});
		
	}
	
	this.map.mapear = function(query_id) {
		
		sld_result = '';		
		
		/**** Generar el SLD ****/
		s = new sldlib();
		capa = s.sld_get_intervalos(query_id); /* Retorna la capa que corresponde por tipo de geometria */
		
		var layer = new ol.layer.Tile({
				visible:true,
				singleTile: true,
				source: new ol.source.TileWMS({
					url: "http://observatorio.ieasa.com.ar:8080/geoserver/ows?",
					params: {
						'LAYERS': capa,//'intervalos_polygons',
						'id':query_id,
						//'VERSION': '1.1.1',
						'FORMAT': 'image/png',
						'TILED': false,
						'SLD':'http://'+window.location.hostname+'/sld/'+query_id+'.sld' /* EL SLD CREADO ES SIEMPRE EL ID_MAPEO.SLD */,
						'viewparams':'id:'+query_id
					}
				})
			});
		
		this.ol_object.addLayer(layer);
		
		var reqExtent = $.ajax({
			
			async:false,
			url:"./php/get-layer-extent-mapeo.php",
			type:"post",
			data:{query_id:query_id},
			success:function(d){}
				
		});
		
		var js = JSON.parse(reqExtent.responseText);
		
		var extent = ol.proj.transformExtent(
			[js.minx,js.miny,js.maxx,js.maxy],
			"EPSG:3857", "EPSG:3857"
		);
		
		this.ol_object.getView().fit(extent,{duration:1000});
		this.ol_object.updateSize();
		this.ol_object.render();
		
		this.panel.AddLayerActiveFromStats(query_id,layer);
		
	}
	
	this.map.deactivateCoordinates = function() {
		
		this.ol_object.removeControl(this.mouse_position_3857);
		this.ol_object.removeControl(this.mouse_position_4326);
		
	}
	
	this.map.activateCoordinates = function() {
		
		this.disableTools();
		
		document.getElementById('coord-3857').innerHTML = "";
		document.getElementById('coord-4326').innerHTML = "";
		
		this.mouse_position_3857 = new ol.control.MousePosition({
			coordinateFormat: ol.coordinate.createStringXY(3),
			projection: 'EPSG:3857',
			className: 'custom-mouse-position',
			target: document.getElementById('coord-3857')
		});
		
		this.mouse_position_4326 = new ol.control.MousePosition({
			coordinateFormat: ol.coordinate.createStringXY(3),
			projection: 'EPSG:4326',
			className: 'custom-mouse-position',
			target: document.getElementById('coord-4326')
		});
		
		this.ol_object.addControl(this.mouse_position_3857);
		this.ol_object.addControl(this.mouse_position_4326);
		
		this.ol_object.infoEnabled = false;
		
		this.ol_object.on("click",this.saveCoordinate);
		
		$("#coord-tbl").show();
		$("#coord-hint").show();
		$("#btn-popup-capturar").hide();
		$("#coord-capture-wrapper").hide();
		
	}
	
	this.map.saveCoordinate = function(e) {
		
		var lon = e.coordinate[0];
		var lat = e.coordinate[1];
		
		var coordarray4326 = ol.proj.transform(e.coordinate,'EPSG:3857', 'EPSG:4326');
		
		var lon4326 = coordarray4326[0];
		var lat4326 = coordarray4326[1];		
		
		var coord_3875 = "Long: " + parseFloat(lon).toFixed(3) + " &nbsp;&nbsp;Lat: " + parseFloat(lat).toFixed(3);
		var coord_4326 = "Long: " + parseFloat(lon4326).toFixed(3) + " &nbsp;&nbspLat: " + parseFloat(lat4326).toFixed(3);
		
		var req = $.ajax({
			
			async:false,
			type:"POST",
			url:"./php/get-coord-transformed.php",
			data:{lon:lon,lat:lat},
			success:function(d){}
			
		});
		
		var js = JSON.parse(req.responseText);
		
		$("#cap-coord-3857").html(coord_3875);
		$("#cap-coord-4326").html(coord_4326);
		$("#cap-coord-100001").html("Long: " + js.coord100001.lon+" &nbsp;&nbspLat: " + js.coord100001.lat);
		$("#cap-coord-100002").html("Long: " + js.coord100002.lon+" &nbsp;&nbspLat: " + js.coord100002.lat);
		$("#cap-coord-100003").html("Long: " + js.coord100003.lon+" &nbsp;&nbspLat: " + js.coord100003.lat);
		
		$("#coord-tbl").hide();
		$("#coord-hint").hide();
		$("#btn-popup-capturar").show();
		$("#coord-capture-wrapper").show();
		
		this.map_object.deactivateCoordinates();
		
		this.map_object.ol_object.infoEnabled = true;
		
		this.un("click",this.map_object.saveCoordinate);
		
	}
	
	this.map.buffer = function(type,node) {
		
		if ($(node).hasClass("toggleable-tool-active")) {
			
			this.buffer.source.clear();
			
			if (this.bufferdraw) { 	this.ol_object.removeInteraction(this.bufferdraw); }
			
			$(node).removeClass("toggleable-tool-active");
			
			this.ol_object.infoEnabled = true;
			
			jwindow.close("popup-buffer");
			
		}else{
			
			$(".toggleable-tool-active").not(node).trigger("click");
			$(node).addClass("toggleable-tool-active");
			this.ol_object.infoEnabled = false;
			
			if (!this.buffer.source) {
				
				this.buffer.source = new ol.source.Vector({
					wrapX: false
				});
				
				var source = this.buffer.source;
				
				this.buffer.layerVector = new ol.layer.Vector({
					source: source
				});
				
				this.ol_object.addLayer(this.buffer.layerVector);
				
			}
			
			var format = new ol.format.WKT();		
			
			if (this.bufferdraw) {
					
				this.ol_object.removeInteraction(this.bufferdraw);
					
			}
			
			if (type == "circle") {
				
				this.bufferdraw = new ol.interaction.Draw({
					source: this.buffer.source,
					type:"Circle"			
				});
				
				this.buffer.type = "circle";
			
			}else{
				
				this.bufferdraw = new ol.interaction.Draw({
					source: this.buffer.source,
					type:"Polygon"			
				});
				
				this.buffer.type = "polygon";
				
			}
			
			$("#buffer-hint").show();
			$("#info-buffer").empty();
			
			this.buffer.source.clear();
			
			this.bufferdraw.on("drawstart",function(e) {
				
				this.ol_object.infoEnabled = false;
				
			}.bind(this));
			
			this.bufferdraw.on('drawend', function (e) {
				
				var format = new ol.format.WKT();			
				
				if (this.buffer.type == "circle") {
					
					var circle = ol.geom.Polygon.fromCircle(e.feature.getGeometry());
				
				}else{
					
					var circle = e.feature.getGeometry();
					
				}
				
				var wkt = format.writeGeometry(circle.transform('EPSG:3857', 'EPSG:4326'));		
				
				var wkt = format.writeGeometry(circle.transform('EPSG:4326', 'EPSG:3857'));	
				
				var layers = [];

				var mapLayers = geomap.map.ol_object.getLayers().getArray();

				for (var i=0; i<mapLayers.length; i++) {
				  
				  if ((mapLayers[i].getVisible()) && (mapLayers[i].getSource().params_)) {
					
					layers.push(mapLayers[i].getSource().params_.layer_id);
					
				  }
				  
				}
				
				var req = $.ajax({
					
					async:false,
					type:"post",
					url:"./php/get-buffer.php",
					data:{wkt:wkt,layers:layers},
					success:function(d){}
					
				});
				
				$("#buffer-hint").hide();
				
				this.parseGFIbuffer(req.responseText,"popup-buffer","info-buffer");

			}.bind(this));
			
			this.ol_object.addInteraction(this.bufferdraw);
			
		}
		
	}
	
	this.map.addBuffer = function(layer_id,dlurl,addLink) {
		
		var distance = $("#buffer-input-"+layer_id).val();
		var dlurl = dlurl += "viewparams=layer_id:"+layer_id+";distancia:"+distance;
		
		if ((isNaN(parseInt(distance))) || (distance.trim() == "")) {
			
			alert("La distancia ingresada es incorrecta o está vacía");
			
		}else{
		
			$("#dlbuffer-link-"+layer_id).attr("href",dlurl);
			
			//addLink.innerHTML = "ACTUALIZAR";
			
			this.readBuffer(layer_id,distance,true);
		
		}
		
	}
	
	this.map.readBuffer = function(layer_id,distance,visible) {
		
		if ((isNaN(parseInt(distance))) || (distance.trim() == "")) {
			
			alert("La distancia ingresada es incorrecta o está vacía");
			
		}else{
			
			var layer = new ol.layer.Tile({
					name:'get_buffer',
					visible:false,
					source: new ol.source.TileWMS({
						url: "http://observatorio.ieasa.com.ar:8080/geoserver/ows?",
						params: {
							'LAYERS': 'get_buffer',
							'VERSION': '1.1.1',
							'FORMAT': 'image/png',
							'TILED': false,
							'viewparams':'layer_id:'+layer_id+";distancia:"+distance
							/*'distancia':distance,
							'layer_id':layer_id*/
						}/*,
						crossOrigin: 'anonymous'*/
					})
				});			
			
			this.layersBuffer[this.layersBufferIndex] = layer;
			
			this.ol_object.addLayer(this.layersBuffer[this.layersBufferIndex]);
			
			this.layersBuffer[this.layersBufferIndex].setVisible(visible);
			this.layersBufferIndex++;
			this.panel.AddLayerActive(-1,layer_id,true,layer,distance);
			
			this.layersBufferIndex++;
			
		}
		
	}
	
	this.map.downloadFeatures = function() {
		
		var features = this.drawing.source.getFeatures();
		
		var writer = new ol.format.GeoJSON();
		var geojsonStr = writer.writeFeatures(features);	
		
		var vectorSource = new ol.source.Vector({
			features: (new ol.format.GeoJSON()).readFeatures(geojsonStr)
		});
		
		var format = new ol.format.KML();
		var kml = format.writeFeatures(vectorSource.getFeatures(), {featureProjection: 'EPSG:3857'});
				
		//var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojsonStr));
		//var blob = new Blob(kml, {type : 'text/html'});
		//var url = URL.createObjectURL(blob);
		
		var req = $.ajax({
			async:false,
			url:"php/create-kml.php",
			type:"post",
			data:{kml:kml},
			success:function(d){}
		});
		
		var js = JSON.parse(req.responseText);
		
		var dlAnchorElem = document.createElement("a");
		
		dlAnchorElem.setAttribute("id","jsondltemp");		
		dlAnchorElem.setAttribute("href",     js.fileurl     );
		dlAnchorElem.setAttribute("download", "content.kml");
		
		document.body.appendChild(dlAnchorElem);	
		
		dlAnchorElem.click();
		
		$("body").remove("#jsondltemp");
	
		if (this.deleteSelect) { this.ol_object.removeInteraction(this.deleteSelect); }
		if (this.select) { this.ol_object.removeInteraction(this.select); }
		if (this.modify) { this.ol_object.removeInteraction(this.modify); }
		if (this.draw) { this.ol_object.removeInteraction(this.draw); }
		if (this.medi_draw) { this.ol_object.removeInteraction(this.medi_draw); }
		if (this.buffer_draw) { this.ol_object.removeInteraction(this.buffer_draw); }
		if (this.ptopo_draw) { this.ol_object.removeInteraction(this.ptopo_draw); }
	
	}
	
	this.map.deleteFeature = function() {		
		
		if (this.deleteSelect) { this.ol_object.removeInteraction(this.deleteSelect); }
		if (this.select) { this.ol_object.removeInteraction(this.select); }
		if (this.modify) { this.ol_object.removeInteraction(this.modify); }
		if (this.draw) { this.ol_object.removeInteraction(this.draw); }
		if (this.medi_draw) { this.ol_object.removeInteraction(this.medi_draw); }
		if (this.buffer_draw) { this.ol_object.removeInteraction(this.buffer_draw); }
		if (this.ptopo_draw) { this.ol_object.removeInteraction(this.ptopo_draw); }
		
		if (this.drawing.source) {
			
			if (!this.deleteSelect) {			
			
				this.deleteSelect = new ol.interaction.Select({
					wrapX: false
				});
				
				var layer = this.drawing.layerVector;
				
				this.deleteSelect.on("select",function(evt) {
					
					var l = evt.target.getFeatures().getLength();
					
					evt.target.getFeatures().forEach(function(f) {
						
						layer.getSource().removeFeature(f);
						
					});;
					
				});
			
			}
			
			this.ol_object.addInteraction(this.deleteSelect);
			
		}
		
	}
	
	this.map.drawing = function(type,node) {
		
		if ($(node).hasClass("toggleable-tool-active")) {
			
			//this.drawing.source.clear();
			
			if (this.draw) { 	this.ol_object.removeInteraction(this.draw); }
			
			$(node).removeClass("toggleable-tool-active");
			
			this.ol_object.infoEnabled = true;
			
		}else{
			
			$(".toggleable-tool-active").not(node).trigger("click");
			$(node).addClass("toggleable-tool-active");
			this.ol_object.infoEnabled = false;
		
			if (!this.drawing.source) {
				
				this.drawing.source = new ol.source.Vector({
					wrapX: false
				});
				
				var source = this.drawing.source;
				
				this.drawing.layerVector = new ol.layer.Vector({
					source: source
				});
				
				this.ol_object.addLayer(this.drawing.layerVector);
				
			}
				
			if (!type) { type = "Point"; }
			
			switch(type) {
				
				case "Select":
				
				if (this.select) {
					
					this.ol_object.removeInteraction(this.select);	
				
				}else{
				
					this.select = new ol.interaction.Select({
						wrapX: false
					});
				
				}
				
				this.select.on('select', function(e) {
				
					var features = e.target.getFeatures().getArray();
					var len = e.target.getFeatures().getLength();
					
					if (len>0) {
						
						jwindow.open("popup-features");
						
						$("#info-features").empty();
						
						for(var i=0; i<len; i++) {
							
							var html = "<div class=\"tarjeta-features\">";							
							
							if (features[i].getGeometry().getType() == "Point") {
								
								html += "<p>Geometría de Punto</p>";
								html += "<p>Coordenadas: "+features[i].getGeometry().getCoordinates()+"</p>";
								
							}
							
							if (features[i].getGeometry().getType() == "LineString") {
								
								html += "<p>Geometría de Líneas</p>";
								html += "<p>Largo: "+((features[i].getGeometry().getLength())/1000)+" Km.</p>";
								
							}
							
							if (features[i].getGeometry().getType() == "Circle") {
								
								html += "<p>Geometría Circular</p>";
								html += "<p>Radio: "+((features[i].getGeometry().getRadius())/1000)+" Km.</p>";
								html += "<p>Centro: "+features[i].getGeometry().getCenter()+"</p>";
								html += "<p>Coordenada Inicial: "+features[i].getGeometry().getFirstCoordinate()+"</p>";
								html += "<p>Coordenada Final: "+features[i].getGeometry().getLastCoordinate()+"</p>";
								
							}
							
							if (features[i].getGeometry().getType() == "Polygon") {
								
								html += "<p>Geometría de Polígono</p>";
								html += "<p>Coordenadas: "+features[i].getGeometry().getCoordinates()+"</p>";
								html += "<p>Extent: "+features[i].getGeometry().getExtent()+"</p>";
								html += "<p>Área: "+((features[i].getGeometry().getArea())/1000)+" Km.</p>";
								
							}
							if (i!=(len-1)) { html += "<hr>"; }
							html += "</div>";
							
							document.getElementById("info-features").innerHTML += html;
						 
						}
					
					}
					 
				});
				
				this.ol_object.addInteraction(this.select);	
				this.ol_object.removeInteraction(this.draw);
				this.ol_object.removeInteraction(this.modify);	
				
				break;
				
				case "Modify":
				
				if (this.modify) {
					
					this.ol_object.removeInteraction(this.modify);			
				
				}else{
				
					if (!this.select) {
						
						this.select = new ol.interaction.Select({
							wrapX: false
						});
						
					}
					
					var select = this.select;
				
					this.modify = new ol.interaction.Modify({
						features: select.getFeatures()
					});
					
				}			
				
				this.ol_object.addInteraction(this.select);
				this.ol_object.addInteraction(this.modify);	
				this.ol_object.removeInteraction(this.draw);
				
				break;
				
				default:
				
				this.draw = new ol.interaction.Draw({
					source: this.drawing.source,
					type:type			
				});
					
				this.ol_object.addInteraction(this.draw);	
				this.ol_object.removeInteraction(this.select);
				this.ol_object.removeInteraction(this.modify);	
				
				break;
				
			}			
			
		}
	
	}
	
	this.map.medicion = function(type,node) {
		
		if ($(node).hasClass("toggleable-tool-active")) {
			
			this.medicion.source.clear();
			
			if (this.medi_draw) { this.ol_object.removeInteraction(this.medi_draw); }
			
			$(node).removeClass("toggleable-tool-active");
			
			this.ol_object.infoEnabled = true;
			
			jwindow.close("popup-medicion");
			
		}else{
			
			$(".toggleable-tool-active").not(node).trigger("click");
			$(node).addClass("toggleable-tool-active");		
			this.ol_object.infoEnabled = false;
			
			if (!this.medicion.source) {
			
				this.medicion.source = new ol.source.Vector({
					wrapX: false
				});
				
				this.medicion.sourcePoints = new ol.source.Vector({
					wrapX: false
				});
				
				this.medicion.layerVector = new ol.layer.Vector({
					source: this.medicion.source
				});
				
				this.medicion.layerPointVector = new ol.layer.Vector({
					source: this.medicion.sourcePoints
				});
				
				this.ol_object.addLayer(this.medicion.layerVector);
				this.ol_object.addLayer(this.medicion.layerPointVector);
			
			}
			
			this.medicion.source.clear();
			
			this.medi_draw = new ol.interaction.Draw({
				source: this.medicion.source,
				type:type	
			});

			this.medi_draw.on('drawend', function (e) {
				
				var format = new ol.format.WKT();
				
				var wkt = format.writeGeometry(e.feature.getGeometry().transform('EPSG:3857', 'EPSG:4326'));
				
				var wktext = wkt;
				
				var wkt = format.writeGeometry(e.feature.getGeometry().transform('EPSG:4326', 'EPSG:3857'));	
								
				var req = $.ajax({
					
					async:false,
					type:"post",
					url:"./php/get-medicion.php",
					data:{wkt:wkt,type:type},
					success:function(d){}
					
				});
				
				document.getElementById("info-medicion").innerHTML = req.responseText;
				
				jwindow.open("popup-medicion");
				
			}.bind(this));
			
			this.ol_object.addInteraction(this.medi_draw);
		
		}
		
	}
	
	this.map.ptopografico = function(node) {
		
		if ($(node).hasClass("toggleable-tool-active")) {
			
			this.ptopografico.source.clear();
			
			if (this.ptopo_draw) { this.ol_object.removeInteraction(this.ptopo_draw); }
			
			$(node).removeClass("toggleable-tool-active");
			
			this.ol_object.infoEnabled = true;
			
			jwindow.close("popup-ptopografico");
			
		}else{
			
			$(".toggleable-tool-active").not(node).trigger("click");
			$(node).addClass("toggleable-tool-active");
			this.ol_object.infoEnabled = false;
			
			if (!this.ptopografico.source) {
			
				this.ptopografico.source = new ol.source.Vector({
					wrapX: false
				});
				
				this.ptopografico.sourcePoints = new ol.source.Vector({
					wrapX: false
				});
				
				this.ptopografico.layerVector = new ol.layer.Vector({
					source: this.ptopografico.source
				});
				
				this.ptopografico.layerPointVector = new ol.layer.Vector({
					source: this.ptopografico.sourcePoints
				});
				
				this.ol_object.addLayer(this.ptopografico.layerVector);
				this.ol_object.addLayer(this.ptopografico.layerPointVector);
			
			}
			
			this.ptopo_draw = new ol.interaction.Draw({
				source: this.ptopografico.source,
				type:"LineString"			
			});
			
			this.ptopo_draw.on('drawend', function (e) {
				
				jwindow.open("popup-preloader");
				
				var format = new ol.format.WKT();
				
				var wkt = format.writeGeometry(e.feature.getGeometry().transform('EPSG:3857', 'EPSG:4326'));		
				
				var wktext = wkt;
				
				var wkt = format.writeGeometry(e.feature.getGeometry().transform('EPSG:4326', 'EPSG:3857'));	
				
				DrawChart(wktext,this.ptopografico.layerVector,this.ptopografico.sourcePoints);
				
			}.bind(this));
			
			this.ol_object.addInteraction(this.ptopo_draw);
		
		}
		
	}
	
	this.map.fixPopup = function(adv) {
		
		if (adv) {
		
			// ARREGLAR FIX POPUP
			var pb_h = $("#popup-body").height();
			var s_h = $("#geovisor-popup-search").height();
			
			var n_h = (pb_h-s_h-300);
			
			$("#dynbox-popup-layers").css("height",n_h+"px");
			
		}else{		
		
			// ARREGLAR FIX POPUP
			var pb_h = $("#popup-body").height();
			var s_h = $("#geovisor-popup-search").height();
			
			var n_h = (pb_h-s_h-300);
			
			$("#dynbox-popup-layers").css("height",n_h+"px");
			
		}
		
	}
	
	this.map.togglePopupLayers = function(node) {
		
		var nodeState = $(node).closest(".popup-layer-node").attr("data-state");
		
		if (nodeState == 0) {
			
			$(node).closest(".popup-layer-node").addClass("popup-layer-node-active");
			
			$(node).closest(".popup-layer-node").each(function(i,v) {
				
				$(v).find(".layer-icon").each(function(j,x) {
					
					var srcSource = $(x).children("a").children("img").attr("data-active");
					
					$(x).children("a").children("img").attr("src",srcSource);
					
				});
				
			});
			
			$(node).closest(".popup-layer-node").attr("data-state","1");
		
		}else{
			
			$(node).closest(".popup-layer-node").removeClass("popup-layer-node-active");
			
			$(node).closest(".popup-layer-node").each(function(i,v) {
				
				$(v).find(".layer-icon").each(function(j,x) {
					
					var srcSource = $(x).children("a").children("img").attr("data-inactive");
					
					$(x).children("a").children("img").attr("src",srcSource);
					
				});
				
			});
			
			$(node).closest(".popup-layer-node").attr("data-state","0");
			
		}
		
		$(node).closest(".popup-layer-node").next(".popup-layer-content").slideToggle("fast",function() { scroll.refresh(); });
		
	}
	
	this.map.fixLegend = function(layer_id) {
		
		var node = $("#layer-legend-"+layer_id);

		var nodeWidth = $(node).width();

		var nodeSon = $(node).children("img");
		
		var nodeSonWidth = $(node).children("img").width();
		
		if (nodeSonWidth >= nodeWidth) {
			
			$(nodeSon).attr("width","95%");
			
		}
		
	}
	
	// PANEL SCRIPTS 
	
	this.panel.map = this.map;
	
	this.panel.start = function() {
		
		var height = $("#nav-panel").height();
		
		$("#nav-panel-inner").height(height-34);
		
		$("#layer-bullet").on("click",function() {
			
			var navWidth = $("#nav-panel").width();
			var navState = $("#nav-panel").attr("data-visible");
			
			flotant.toggle('#nav-panel',true,function() {
				
				if (navState == 1) {
					
					$("#layer-bullet").animate({"left":"0px"},"fast");
					
				}else{
					
					$("#layer-bullet").animate({"left":(navWidth-59)+"px"},"fast");
					
				}
				
			});
			
		});
		
		$("#btn-bus-simple").on("click",function() {
			
			$("#geovisor-popup-search").slideUp();
			$("#geovisor-popup-search-mobile").slideUp();
			$("#popup-basic-filters").slideDown();
			$("#popup-header .button").removeClass("button-active");
			$(this).addClass("button-active");
			
			geomap.map.fixPopup(false);
			scroll.refresh();
			
		});
		
		$("#btn-bus-advanced").on("click",function() {
			
			$("#geovisor-popup-search").slideDown();
			$("#geovisor-popup-search-mobile").slideDown();
			$("#popup-basic-filters").slideUp();
			$("#popup-header .button").removeClass("button-active");
			$(this).addClass("button-active");
			
			geomap.map.fixPopup(true);
			scroll.refresh();
			
		});
		
		$("#btn-bus-reset").on("click",function() {
			
			$("#frm-adv-search input[type=text]").val("");
			$("#frm-adv-search select").val(-1);
			$("#frm-adv-search select").selectpicker("refresh");

			$("#popup-basic-filters input[type=checkbox]:checked").trigger("click");
			
			$("#filtered-layer-list").empty();
			
			geomap.map.fixPopup(true);
			scroll.refresh();
			
		});
		
		$(".default-empty-checkbox").each(function(i,v) {
			
			v.checked = false;
			
		});
		
		$(".phanel .panel-arrow-link").each(function(i,v) {
			
			$(v).on("click",function() {
				
				if (v.getAttribute("data-state") == 1) {
													
					$(v).parent().parent().parent().animate({
						
						left:$("#page").offset().left-370 + "px"
						
					},1000,function() {
						
						$(v).children("img").attr("src","./images/panel.icon.arrow.0.png");
						
					});
					
					$(v).attr("data-state",0);
					
				}else{
					
					$(v).parent().parent().parent().animate({
						
						left:$("#page").css("left")
						
					},1000,function() {
						
						$(v).children("img").attr("src","./images/panel.icon.arrow.1.png");
						
					});
					
					$(v).attr("data-state",1);
				}
				
			});
			
		});
		
		$(".panel-abr").on("click",function() {
			
			if (this.getAttribute("data-active") == 0) {
				
				$(".panel-abr").attr("data-active","0");
				//$(".panel-abr").css("border-color","transparent");
				//$(".panel-abr").css("background-color","transparent");
				$(".panel-abr").css("background-color","#F5F5F5");
				$(".panel-abr").css("color","#888888");
				
				$(this).attr("data-active","1");
				//$(this).css("border-color",this.getAttribute("data-color"));
				//$(this).css("background-color",this.getAttribute("data-bgcolor"));
				$(this).css("background-color","#31cbfd");
				$(this).css("color","#FFFFFF");
				
				$(".layer-container").not(".layer-container[data-cid="+this.getAttribute("data-cid")+"]").hide();
				$(".layer-container[data-cid="+this.getAttribute("data-cid")+"]").show();
				
				//$("#abr-container").first(".panel-abr").prepend(this);			
				scroll.refresh();
				
			}
			
		});
		
		$("#panel-seach-input").on("focus",function() {
			
			$(".popup").hide();
			$("#popup-busqueda").show();
			
			this.map.ol_object_mini.updateSize();
			this.map.ol_object_mini.render();
			
		}.bind(this));
		
		$(".basic-filter-checkbox").each(function(i,v) {
			
			$(v).on("click",function() {
			
				this.UpdatePopupListBasic();
				
			}.bind(this));
			
		}.bind(this));
		
		$("#btn-adv-search").on("click",function() {
			
			this.UpdatePopupListAdvanced();
			
		}.bind(this));
		
		$("#btn-adv-search-mobile").on("click",function() {
			
			this.UpdatePopupListAdvanced();
			
		}.bind(this));
		
		$(".simple-tree-pm-button").each(function(i,v) {
			
			$(v).on("click",function() {
			
				if ($(v).children("i").hasClass("fa-angle-up")) {
					
					$(v).children("i").removeClass("fa-angle-up");
					$(v).children("i").addClass("fa-angle-down");
					
				}else{
					
					$(v).children("i").removeClass("fa-angle-down");
					$(v).children("i").addClass("fa-angle-up");
					
				}
				
				$(v).parent().next('.layer-body').slideToggle('slow');
			
			});
			
		});
		
		$("form input").val("");
		$("form select").prop("selectedIndex", 0);
		$("form select").selectpicker("refresh");
		
		$(".layer-icon-buffer").each(function(i,v) {
			
			$(v).bind("click",function() {
				
				if ($(v).attr("data-state") == 1) {
					
					var layer_id = $(v).attr("data-lid");
					
					if (this.map.layersBuffer[layer_id]) {
						this.map.layersBuffer[layer_id].destroy();
						this.map.layersBuffer[layer_id] = false;
					}
					
					
				}
				
			}.bind(this));
			
		}.bind(this));
		
	}
	
	this.panel.UpdatePopupListBasic = function() {
		
		var filter = [];
		
		$(".basic-filter-checkbox").each(function() {
			
			if (this.checked) {
				
				filter.push(this.getAttribute("data-spid"));
				
			}
			
		});
		
		var geovisor = this.map.geovisor;
		
		var req = $.ajax({
			
			async:false,
			type:"post",
			data:{proyectos:filter,geovisor:geovisor},
			url:"./php/filter-proyectos-basic.php",
			success:function(d){}
			
		});
		
		$("#filtered-layer-list").html(req.responseText);		
		
		scroll.refresh();		
		
		$(".popup-panel-tree-item-header").on("click",function() {
			
			if (this.parentNode.getAttribute("data-state") == 1) {
				
				$(this).find(".popup-panel-tree-item-icon").removeClass("far").removeClass("popup-icon-active").addClass("fas");
				
				$(this).find(".popup-panel-tree-item-label").removeClass("popup-text-active");
				
				$(this).find(".popup-panel-tree-item-icon-toggler").removeClass("fa-angle-up").addClass("fa-angle-down");
				
				$(this).next(".popup-panel-tree-item-subpanel").slideToggle("slow",function() {					
					
					scroll.refresh();
					
				});
				
				this.parentNode.setAttribute("data-state",0);
				
			}else{
				
				$(this).find(".popup-panel-tree-item-icon").addClass("far").addClass("popup-icon-active").removeClass("fas");
				
				$(this).find(".popup-panel-tree-item-label").addClass("popup-text-active");
				
				$(this).find(".popup-panel-tree-item-icon-toggler").removeClass("fa-angle-down").addClass("fa-angle-up");
				
				$(this).next(".popup-panel-tree-item-subpanel").slideToggle("slow",function() {					
					
					scroll.refresh();
					
				});
				
				this.parentNode.setAttribute("data-state",1);
				
			}
			
		});
	}
	
	this.panel.UpdatePopupListAdvanced = function(mode) {
		
		if ($("#frm-adv-search:visible").length > 0) {
			
			var filter = $("#frm-adv-search").serialize();
			
		}else{
			
			var filter = $("#frm-adv-search-mobile").serialize();
			
		}
		
		var geovisor = this.map.geovisor;
		
		var req = $.ajax({
			
			async:false,
			type:"post",
			data:filter+"&geovisor="+geovisor,
			url:"./php/filter-proyectos-advanced.php",
			success:function(d){}
			
		});
		
		$("#filtered-layer-list").html(req.responseText);		
		
		scroll.refresh();		
		
		$(".popup-panel-tree-item-header").on("click",function() {			
			
			if (this.parentNode.getAttribute("data-state") == 1) {
				
				$(this).find(".popup-panel-tree-item-icon").removeClass("far").removeClass("popup-icon-active").addClass("fas");
				
				$(this).find(".popup-panel-tree-item-label").removeClass("popup-text-active");
				
				$(this).find(".popup-panel-tree-item-icon-toggler").removeClass("fa-minus-circle").addClass("fa-plus-circle");
				
				$(this).next(".popup-panel-tree-item-subpanel").slideToggle("slow",function() {					
					
					scroll.refresh();
					
				});
				
				this.parentNode.setAttribute("data-state",0);
				
			}else{
				
				$(this).find(".popup-panel-tree-item-icon").addClass("far").addClass("popup-icon-active").removeClass("fas");
				
				$(this).find(".popup-panel-tree-item-label").addClass("popup-text-active");
				
				$(this).find(".popup-panel-tree-item-icon-toggler").removeClass("fa-plus-circle").addClass("fa-minus-circle");
				
				$(this).next(".popup-panel-tree-item-subpanel").slideToggle("slow",function() {					
					
					scroll.refresh();
					
				});
				
				this.parentNode.setAttribute("data-state",1);
				
			}
			
		});
		
	}
	
	this.panel.PreviewLayer = function(layer_id) {
		
		var req = $.ajax({
			
			async:false,
			url:"./php/get-layer-preview.php",
			type:"post",
			data:{layer_id:layer_id},
			success:function(d){}
			
		});
		
		$("#layer-preview-block").html(req.responseText);
		
		var clase_id = $(".layer-group[data-layer="+layer_id+"]").attr("data-cid");		
		$("#btn-layer-preview-addlayer").attr("onclick","geomap.panel.AddLayer(" + clase_id + "," + layer_id + ",true,true)");
		
		$("#btn-layer-preview-addlayer").show();
		$("#btn-layer-preview-gomap").show();
		
		if (!document.getElementById("layer-checkbox-"+layer_id).layer_preview) {
			
			var layer_name = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-layer");
			var layer_wms = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-wms");
			
			document.getElementById("layer-checkbox-"+layer_id).layer_preview = new ol.layer.Tile({
				visible:true,
				source: new ol.source.TileWMS({
					url: layer_wms,
					params: {
						'LAYERS': layer_name,
						'VERSION': '1.1.1',
						'FORMAT': 'image/png',
						'TILED': false
					}
				})
			});
			
			this.map.ol_object_mini.addLayer(document.getElementById("layer-checkbox-"+layer_id).layer_preview);

		}
		
		var js = this.map.getLayerExtent(layer_id);
		
		var allLayers = geomap.map.ol_object_mini.getLayers().getArray();
		
		for (var i=0; i<allLayers.length; i++) {
			
			if (allLayers[i].get('name') != "google_base") {
				
				allLayers[i].setVisible(false);
			
			}
			
		}
		
		document.getElementById("layer-checkbox-"+layer_id).layer_preview.setVisible(true);
		
		var extent = ol.proj.transformExtent(
			[js.minx,js.miny,js.maxx,js.maxy],
			"EPSG:3857", "EPSG:3857"
		);
		
		this.map.ol_object_mini.getView().fit(extent,{duration:1000});
		this.map.ol_object_mini.updateSize();
		this.map.ol_object_mini.render();
		
	}
	
	this.panel.SetLayerActive = function(layer_id) {
		
		$(".layer-group[data-layer="+layer_id+"] .layer-label").addClass("layer-label-active");
		$(".layer-group[data-layer="+layer_id+"] .layer-body").show();
		
	}
	
	this.panel.AddLayer = function(clase_id,layer_id,startActive,visible) {
		
		$(".abr[data-cid="+clase_id+"]").show();
		$(".abr[data-cid="+clase_id+"]").trigger("click");
		$(".layer-group[data-layer="+layer_id+"]").show();
		
		if (startActive) {
			
			//$(".layer-group[data-layer="+layer_id+"] .layer-label").addClass("layer-label-active");
			//$(".layer-group[data-layer="+layer_id+"] .layer-body").show();
			
		}else{
			
			//$(".layer-group[data-layer="+layer_id+"] .layer-label").removeClass("layer-label-active");
			//$(".layer-group[data-layer="+layer_id+"] .layer-body").hide();
			
		}
					
		if (document.getElementById("layer-checkbox-"+layer_id)) {
			var layer_name = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-layer");
		}
		
		if (document.getElementById("layer-checkbox-"+layer_id)) {
			var layer_wms = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-wms");
		}
		
		if (visible) {
		
			this.CreateLayer(layer_id,layer_wms,layer_name,clase_id);
			
		}
		
		//document.getElementById("layer-checkbox-"+layer_id).layer.setVisible(false);
		
		$("#layer-checkbox-"+layer_id).bind("click",function() {
			
			if (document.getElementById("layer-checkbox-"+layer_id).checked) {
				
				if (!document.getElementById("layer-checkbox-"+layer_id).layer) {
					
					this.CreateLayer(layer_id,layer_wms,layer_name,clase_id);
					
				}else{
				
					document.getElementById("layer-checkbox-"+layer_id).layer.setVisible(true);
				
				}
				
			}else{
				
				document.getElementById("layer-checkbox-"+layer_id).layer.setVisible(false);
				
			}
			
		}.bind(this));
			
		//$( "#amount" ).val( "$" + $( "#slider-range" ).slider( "values", 0 ) + " - $" + $( "#slider-range" ).slider( "values", 1 ) );
		
	}
	
	this.panel.CreateLayer = function(layer_id,layer_wms,layer_name,clase_id) {
					
		document.getElementById("layer-checkbox-"+layer_id).layer = new ol.layer.Tile({
			name:layer_name,
			visible:true,
			source: new ol.source.TileWMS({
				url: layer_wms,
				params: {
					'LAYERS': layer_name,
					'VERSION': '1.1.1',
					'FORMAT': 'image/png',
					'TILED': false,
					'clase_id':clase_id,
					'layer_id':layer_id
				}/*,
				crossOrigin: 'anonymous'*/
			})
		});
		
		this.map.ol_object.addLayer(document.getElementById("layer-checkbox-"+layer_id).layer);
		
		$("#layer-checkbox-"+layer_id).attr("data-added","1");
		
		document.getElementById("layer-checkbox-"+layer_id).layer.colorpicker = true;

		var colorpickerInput = $("#layer-colorpicker-inner-"+layer_id);
		
		colorpickerInput.spectrum({
			color: "#ECC",
			flat: true,
			showInput: true,
			className: "full-spectrum",
			showInitial: true,
			showPalette: true,
			showSelectionPalette: true,
			maxPaletteSize: 10,
			preferredFormat: "hex",
			localStorageKey: "spectrum.example",
			chooseText: "Seleccionar",
			cancelText: "Cancelar",
			move: function (color) {
			},
			show: function () {

			},
			beforeShow: function () {

			},
			hide: function (color) {
			},
			change: function(color) {
				
				var layer = document.getElementById("layer-checkbox-"+layer_id).layer;
				var layer_name = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-layer");
				var type = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-layer-type");
				var layer_types = ['',0,1,2,2,1,0,0];
				var cl = String(color);
					cl = cl.substring(1,cl.length).trim();
				
				s = new sldlib();
				
				s.set_geometria(layer_types[type]);
				s.set_fill_color(cl);
				s.set_border_color('CCCCCC');
				s.set_border_size(1);
				s.set_size(8.3444);
				s.set_simbolo('circle');
				s.set_titulo(layer_name);
				
				sld_result = s.sld_get(layer_id);
				
				layer.getSource().updateParams({
					
					'sld_body':sld_result
					
				})
				
				//layer.changed();
				layer.getSource().tileCache.expireCache({});
				layer.getSource().tileCache.clear();
				layer.getSource().refresh();
				
				$("#palette-clear-layer").remove();
				
				$(".sp-palette-row-selection").append(
					$("<span></span>")
						.attr("class","sp-thumb")
						.attr("id","palette-clear-layer")
						.attr("title","Reiniciar Estilo")
						.css({
							display:"inline-flex",
							justifyContent:"center",
							alignItems:"center",
							cursor:"pointer",
							width:"18px",
							height:"18px"
						})
						.append($("<i></i>").attr("class","fas fa-ban").css("color","red"))
						.on("click",function() {
							
							var layer = document.getElementById("layer-checkbox-"+layer_id).layer;
							var layer_name = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-layer");
							var type = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-layer-type");
							var layer_types = ['',0,1,2,2,1,0,0];
							var cl = String(color);
								cl = cl.substring(1,cl.length).trim();
							
							s = new sldlib();
							
							sld_result = s.sld_get(layer_id);
							
							s.clear();
							
							layer.getSource().updateParams({
								
								'sld_body':sld_result
								
							})
							
							//layer.changed();
							layer.getSource().tileCache.expireCache({});
							layer.getSource().tileCache.clear();
							layer.getSource().refresh();
							
						})
				);
				
			},

			palette: [
				["rgb(0, 0, 0)", "rgb(67, 67, 67)", "rgb(102, 102, 102)","rgb(255, 255, 255)",
				"rgb(152, 0, 0)", "rgb(255, 0, 0)", "rgb(255, 153, 0)", "rgb(255, 255, 0)", "rgb(0, 255, 0)",
				"rgb(0, 255, 255)", "rgb(74, 134, 232)", "rgb(0, 0, 255)", "rgb(153, 0, 255)", "rgb(255, 0, 255)",
				"rgb(230, 184, 175)", "rgb(244, 204, 204)", "rgb(252, 229, 205)", "rgb(255, 242, 204)", "rgb(217, 234, 211)",
				"rgb(208, 224, 227)", "rgb(201, 218, 248)", "rgb(207, 226, 243)", "rgb(217, 210, 233)", "rgb(234, 209, 220)",
				"rgb(221, 126, 107)", "rgb(234, 153, 153)", "rgb(249, 203, 156)", "rgb(255, 229, 153)", "rgb(182, 215, 168)",
				"rgb(162, 196, 201)", "rgb(164, 194, 244)", "rgb(159, 197, 232)", "rgb(180, 167, 214)", "rgb(213, 166, 189)",
				"rgb(204, 65, 37)", "rgb(224, 102, 102)", "rgb(246, 178, 107)", "rgb(255, 217, 102)", "rgb(147, 196, 125)",
				"rgb(118, 165, 175)", "rgb(109, 158, 235)", "rgb(111, 168, 220)", "rgb(142, 124, 195)", "rgb(194, 123, 160)",
				"rgb(166, 28, 0)", "rgb(204, 0, 0)", "rgb(230, 145, 56)", "rgb(241, 194, 50)", "rgb(106, 168, 79)",
				"rgb(69, 129, 142)", "rgb(60, 120, 216)", "rgb(61, 133, 198)", "rgb(103, 78, 167)", "rgb(166, 77, 121)",
				"rgb(91, 15, 0)", "rgb(102, 0, 0)", "rgb(120, 63, 4)", "rgb(127, 96, 0)", "rgb(39, 78, 19)",
				"rgb(12, 52, 61)", "rgb(28, 69, 135)", "rgb(7, 55, 99)", "rgb(32, 18, 77)", "rgb(76, 17, 48)"]
			]
		});
		
		/*$("#layer-colorpicker-inner-"+layer_id).ColorPicker({
			flat: true, 
			width:"100%",
			onSubmit: function (hsb, hex, rgb) {
				
				//var layer_types = ["","GEOMETRY","LINESTRING","POLYGON","MULTIPOLYGON","MULTILINESTRING","POINT","MULTIPOINT");
				var layer = document.getElementById("layer-checkbox-"+layer_id).layer;
				var color = hex;
				var layer_name = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-layer");
				var type = document.getElementById("layer-checkbox-"+layer_id).getAttribute("data-layer-type");
				var layer_types = ['',0,1,2,2,1,0,0];
				
				s = new sldlib();
				
				s.set_geometria(layer_types[type]);
				s.set_fill_color("#"+hex);
				s.set_border_color('#CCCCCC');
				s.set_border_size(1);
				s.set_size(8.3444);
				s.set_simbolo('circle');
				s.set_titulo(layer_name);
				
				sld_result = s.sld_get();
				
				layer.getSource().updateParams({
					
					'sld_body':sld_result
					
				})
				
				//layer.changed();
				layer.getSource().tileCache.expireCache({});
				layer.getSource().tileCache.clear();
				layer.getSource().refresh();
				
			}
		});*/
		
		$(".layer-group[data-layer="+layer_id+"] .layer-label").bind("click",function() {
			
			$("#layer-legend-"+layer_id).html("<img onload=\"geomap.map.fixLegend("+layer_id+")\"; src=\"" + layer_wms + "&version=1.3.0&service=WMS&request=GetLegendGraphic&sld_version=1.1.0&layer="+layer_name+"&format=image/png&\">");
			
		});
		
		
		if ($("#nav-panel").attr("data-visible") == 0) {
			
			$("#layer-bullet").trigger("click");
			
		}
		
		$("#layer-checkbox-"+layer_id).attr("data-added","1");
		
		$("#transp-value-"+layer_id).val(100+"%");
		
		$( "#slider-range-"+layer_id ).slider({			
			values: [ 100 ],
			slide: function( event, ui ) {
				$("#transp-value-"+layer_id).val(ui.values[ 0 ]+"%");
				document.getElementById("layer-checkbox-"+layer_id).layer.setOpacity(ui.values[0]/100);				
			}
		});
		
		this.AddLayerActive(clase_id,layer_id,false,-1,-1);
		this.map.updateLayerCount();
		this.updateLayerCountPanelLabel(clase_id);
		
		document.getElementById("layer-checkbox-"+layer_id).click();
		
	}
	
	this.panel.bufferIndex = 0;
	this.panel.statsLayerIndex = 0;
	
	this.panel.AddLayerActive = function(clase_id,layer_id,isBuffer,bufferLayer,distance) {
		
		$("#nolayer-active").remove();
		
		var dataLidLabel = "data-lid";
		
		var container = document.getElementById("info-capasactivas-inner");
		
		var node = document.createElement("div");
			node.className = "active-layer-node";	
			node.setAttribute(dataLidLabel,layer_id);
			node.setAttribute("data-cid",clase_id);
			
		var nodeicons = document.createElement("div");
			nodeicons.className = "active-layer-node-icons";
			
		var nodeupdown = document.createElement("div");
			nodeupdown.className = "updown-layer-icon-ca";
			
		var nodeup = document.createElement("div");
			nodeup.className = "up-layer-icon-ca";
			nodeup.node = node;
			nodeup.panel = this;
			nodeup.onclick = function() {
				
				$(this.node).prev(".active-layer-node").before(node);				
				this.panel.RefreshActiveZIndex();
				
			}
			
		var nodedown = document.createElement("div");
			nodedown.className = "down-layer-icon-ca";
			nodedown.node = node;
			nodedown.panel = this;
			nodedown.onclick = function() {
				
				$(this.node).next(".active-layer-node").after(node);				
				this.panel.RefreshActiveZIndex();
				
			}
			
			nodeupdown.appendChild(nodeup);
			nodeupdown.appendChild(nodedown);
		
		var new_id = "active-layer-clone-" + clase_id + "-" + layer_id;
		
		if ($("#info-capasactivas").find("#"+new_id).length == 0) {
		
			$(".abr[data-cid="+clase_id+"]").first().clone().attr("id",new_id).addClass("abr-cloned").width(32).css("background-color","rgb(245, 245, 245)").css("color","rgb(136, 136, 136)").appendTo(node);
				
			if (isBuffer) {
				
				this.bufferIndex++;
				
				sublayer_id = "layer-buffer-" + layer_id + "-" + this.bufferIndex;
				
				$("#layer-checkbox-"+layer_id).parent().clone().attr("id",sublayer_id).on("click",function() {
					
					if (bufferLayer.getVisible()) {
						
						bufferLayer.setVisible(false);
							
					}else{
							
						bufferLayer.setVisible(true);
							
					}
					
				}).appendTo(node);
			
			}else{
								
				$("#layer-checkbox-"+layer_id).parent().clone().on("click",function() {
					
					$("#layer-checkbox-"+layer_id).trigger("click");
					
				}).appendTo(node);
				
			}
			
			var text = $("#layer-checkbox-"+layer_id).parent().next().text();
			
			/*if (text.length > 33) {
				
				text = text.substring(0,33) + "...";
				
			}*/
			
			if (isBuffer) { text = "Buffer: " + text + ", Distancia: " + distance }
			
			$("#layer-checkbox-"+layer_id).parent().next().clone().attr("onclick","").text(text).css("cursor","text").appendTo(node);	
			
			nodeicons.appendChild(nodeupdown);
			
			$("#layer-checkbox-"+layer_id).parent().next().next().clone().removeAttr("id").removeAttr("onclick").addClass("remove-layer-icon-ca").bind("click",function() {
				
				if (isBuffer) {
					
					geomap.map.ol_object.removeLayer(layerBuffer);
					$("#"+sublayer_id).parent().remove();
				
				}else{
					
					$("#remove-layer-icon-"+layer_id).trigger("click");
					
				}
				
				if ($("#info-capasactivas-inner").children(".active-layer-node").length == 0) {
					
					$("#info-capasactivas-inner").html("<p id=\"nolayer-active\" class=\"p20\">No hay capas activas, para agregar capas al mapa utilice el botón correspondiente ubicado en la barra de herramientas.</p>");
					
				}
				
			}).appendTo(nodeicons);		
			
			$("#layer-icon-zoomext-"+layer_id).clone().removeAttr("id").addClass("zoomext-layer-icon-ca").bind("click",function() {
				
				$("#layer-icon-zoomext-"+layer_id).trigger("click");
				
			}).appendTo(nodeicons);
			
			node.appendChild(nodeicons);
			
					
		}		
			
		container.appendChild(node);
		
		this.RefreshActiveZIndex();
		
	}
	
	this.panel.AddLayerActiveFromStats = function(query_id,layer) {
		
		$("#nolayer-active").remove();
		
		var layer_id = this.map.layersStatsIndex;
		var clase_id = this.map.layersStatsIndex;
		this.map.layersStats[this.map.layersStatsIndex] = layer;
		
		this.map.layersStatsIndex++;
		
		var dataLidLabel = "data-lid";
		
		var container = document.getElementById("info-capasactivas-inner");
		
		var node = document.createElement("div");
			node.className = "active-layer-node";	
			node.setAttribute(dataLidLabel,layer_id);
			node.setAttribute("data-cid",clase_id);
			
		var nodeicons = document.createElement("div");
			nodeicons.className = "active-layer-node-icons";
			
		var nodeupdown = document.createElement("div");
			nodeupdown.className = "updown-layer-icon-ca";
			
		var nodeup = document.createElement("div");
			nodeup.className = "up-layer-icon-ca";
			nodeup.node = node;
			nodeup.panel = this;
			nodeup.onclick = function() {
				
				$(this.node).prev(".active-layer-node").before(node);				
				this.panel.RefreshActiveZIndex();
				
			}
			
		var nodedown = document.createElement("div");
			nodedown.className = "down-layer-icon-ca";
			nodedown.node = node;
			nodedown.panel = this;
			nodedown.onclick = function() {
				
				$(this.node).next(".active-layer-node").after(node);				
				this.panel.RefreshActiveZIndex();
				
			}
			
			nodeupdown.appendChild(nodeup);
			nodeupdown.appendChild(nodedown);
			
		var nodezoomext = document.createElement("div");
			nodezoomext.className = "layer-icon zoomext-layer-icon-ca";
		
		var nodezoomexta = document.createElement("a");
			nodezoomexta.href = "javascript:void(0);";
			nodezoomexta.onclick = function() {
				
				var reqExtent = $.ajax({
			
					async:false,
					url:"./php/get-layer-extent-mapeo.php",
					type:"post",
					data:{query_id:query_id},
					success:function(d){}
						
				});
				
				var js = JSON.parse(reqExtent.responseText);
				
				var extent = ol.proj.transformExtent(
					[js.minx,js.miny,js.maxx,js.maxy],
					"EPSG:3857", "EPSG:3857"
				);
				
				this.map.ol_object.getView().fit(extent,{duration:1000});
				this.map.ol_object.updateSize();
				this.map.ol_object.render();
				
			}.bind(this);
			
		var nodezoomextimg = document.createElement("img");
			nodezoomextimg.src = "./images/geovisor/icons/layer-bar-zoom.png";
			
			nodezoomext.appendChild(nodezoomexta);
			nodezoomexta.appendChild(nodezoomextimg);
			
		var noderemove = document.createElement("a");
			noderemove.className = "simple-tree-pm-button remove-layer-icon-ca";
			noderemove.href = "javascript:void(0);";
			noderemove.onclick = function() {
				
				$(noderemove).closest(".active-layer-node").remove();
				this.map.ol_object.removeLayer(layer);
				
				if ($("#info-capasactivas-inner").children(".active-layer-node").length == 0) {
					
					$("#info-capasactivas-inner").html("<p id=\"nolayer-active\" class=\"p20\">No hay capas activas, para agregar capas al mapa utilice el botón correspondiente ubicado en la barra de herramientas.</p>");
					
				}
				
			}.bind(this);
			
		var noderemovei = document.createElement("i");
			noderemovei.className = "fa fa-trash popup-panel-tree-item-icon-toggler popup-icon";
			
			noderemove.appendChild(noderemovei);
			
			nodeicons.appendChild(nodeupdown);
			nodeicons.appendChild(nodezoomext);
			nodeicons.appendChild(noderemove);
		
		var abr = document.createElement("div");
			abr.className = "abr panel-abr abr-cloned";
			abr.style.width = "32px";
			abr.style.backgroundColor = "rgb(245, 245, 245)";
			abr.style.color = "rgb(136, 136, 136)";
			abr.innerHTML = "<span>DT</span>";
			abr.id = "active-layer-fromstats-"+this.statsLayerIndex;
		
			//$(".abr").first().clone().attr("id",new_id).addClass("abr-cloned").width(32).css("background-color","rgb(245, 245, 245)").css("color","rgb(136, 136, 136)").html("<span>DT</span>").appendTo(node);
		
		var pretty = document.createElement("div");
			pretty.className = "pretty p-default p-curve p-toggle";
			
		var layerCheck = document.createElement("input");
			layerCheck.id = "layer-checkbox-"+layer_id;
			layerCheck.className = "layer-checkbox default-empty-checkbox";
			layerCheck.style.display = "block";
			layerCheck.setAttribute("data-added","1");
			layerCheck.setAttribute("type","checkbox");
			layerCheck.layer = layer;
			layerCheck.onclick = function() {
				
				if (layer.getVisible()) {
					
					layer.setVisible(false);
						
				}else{
						
					layer.setVisible(true);
						
				}
				
			}
			
		var layerCheckDivon = document.createElement("div");
			layerCheckDivon.className = "state p-success p-on";
			layerCheckDivon.title = "Mostrar Capa";
			
		var layerCheckDivonIcon = document.createElement("i");
			layerCheckDivonIcon.className = "fa fa-eye";
			
			layerCheckDivon.appendChild(layerCheckDivonIcon);
			
		var layerCheckDivoff = document.createElement("div");
			layerCheckDivoff.className = "state p-danger p-off";
			layerCheckDivoff.title = "Ocultar Capa";
			
		var layerCheckDivoffIcon = document.createElement("i");
			layerCheckDivoffIcon.className = "fa fa-eye-slash";
			
			layerCheckDivoff.appendChild(layerCheckDivoffIcon);
			
			pretty.appendChild(layerCheck);
			pretty.appendChild(layerCheckDivoff);
			pretty.appendChild(layerCheckDivon);
			
		var layerLabel = document.createElement("a");
			layerLabel.className = "layer-label";
			layerLabel.style.cursor = "text";
			layerLabel.innerHTML = "Capa mapeada desde módulo estadístico";			
			
			node.appendChild(abr);
			node.appendChild(pretty);
			node.appendChild(layerLabel);
			node.appendChild(nodeicons);
			
			this.statsLayerIndex++;
			
			container.appendChild(node);
		
			this.RefreshActiveZIndex();
		
	}
	
	this.panel.RefreshActiveZIndex = function() {
		
		var nodes = document.getElementsByClassName("active-layer-node");
				
		for (var i=0, j=nodes.length; i<nodes.length; i++,j--) {
			
			var layer_id = nodes[i].getAttribute("data-lid");
			
			if (document.getElementById("layer-checkbox-"+layer_id)) {
			
				document.getElementById("layer-checkbox-"+layer_id).layer.setZIndex(j);
			
			}else{
				
				if (document.getElementById("layer-buffer-"+layer_id)) {
					
					document.getElementById("layer-buffer-"+layer_id).layer.setZIndex(j);
					
				}
				
			}
						
		}
		
		if (this.map.markersLayer) {
			
			this.map.markersLayer.setZIndex(j+10000);
			
		}
		
	}
	
	this.panel.removeLayer = function(layer_id,clase_id) {
		
		$(".layer-group[data-layer="+layer_id+"]").hide();
		document.getElementById("layer-checkbox-"+layer_id).layer.setVisible(false);
		
		$("#layer-checkbox-"+layer_id).attr("data-added","0");
		
		var visibles = $(".layer-container[data-cid="+clase_id+"] .layer-group:visible").length;
		
		if (visibles == 0) {
			
			$(".layer-container[data-cid="+clase_id+"]").hide();
			$(".panel-abr[data-cid="+clase_id+"]").hide();
			$(".panel-abr[data-cid="+clase_id+"]").attr("data-active","0");
			
		}
		
		if (this.map.layersBuffer[layer_id]) {
		
			var layer = this.map.layersBuffer[layer_id];
			
			this.map.ol_object.removeLayer(layer);
			
			this.map.layersBuffer[layer_id] = false;
			
			$("#buffer-input-"+layer_id).val("");
			$("#buffer-input-"+layer_id).next().html("AGREGAR");
		
		}
		
		$(".active-layer-node[data-lid="+layer_id+"]").remove();
		
		if ($("#info-capasactivas-inner").children(".active-layer-node").length == 0) {
					
			$("#info-capasactivas-inner").html("<p id=\"nolayer-active\" class=\"p20\">No hay capas activas, para agregar capas al mapa utilice el botón correspondiente ubicado en la barra de herramientas.</p>");
			
		}
		
		this.updateLayerCountPanelLabel(clase_id);
		
	}
	
	this.panel.checkBuffer = function(layer_id,clase_id,node) {
		
		var state = node.getAttribute("data-state");
		
		if (state == 1) {
			
			var layer = this.map.layersBuffer[layer_id];
			
			this.map.ol_object.removeLayer(layer);
			
			this.map.layersBuffer[layer_id] = false;
			
			$("#buffer-input-"+layer_id).val("");
			$("#buffer-input-"+layer_id).next().html("AGREGAR");
			
		}
		
	}
	
	this.panel.updateLayerCountPanelLabel = function(clase_id) {
		
		var cant = $(".layer-container[data-cid="+clase_id+"]:visible").find(".layer-group:visible").length;
		$("#abr-layer-count-"+clase_id).html(cant);
		
	}
	
	// POPUP SCRIPTS
	
	this.popup.panel = this.panel;
	
	this.popup.startInterface = function() {
		
		$(".popup-header-button-toggleable").on("click",function() {
			
			var thistar = this.getAttribute("data-target");
			
			$(this).closest(".nav").find(".popup-header-button-toggleable").not(this).removeClass("popup-header-button-active");
			
			$(this).addClass("popup-header-button-active");
			
		});
		
		$(".popup-panel-tree-item-header").on("click",function() {
			
			if (this.parentNode.getAttribute("data-state") == 1) {
				
				$(this).find(".popup-panel-tree-item-icon").removeClass("far").removeClass("popup-icon-active").addClass("fas");
				
				$(this).find(".popup-panel-tree-item-label").removeClass("popup-text-active");
				
				$(this).find(".popup-panel-tree-item-icon-toggler").removeClass("fa-minus-circle").addClass("fa-plus-circle");
				
				$(this).next(".popup-panel-tree-item-subpanel").slideToggle("slow",function() {					
					
					scroll.refresh();
					
				});
				
				this.parentNode.setAttribute("data-state",0);
				
			}else{
				
				$(this).find(".popup-panel-tree-item-icon").addClass("far").addClass("popup-icon-active").removeClass("fas");
				
				$(this).find(".popup-panel-tree-item-label").addClass("popup-text-active");
				
				$(this).find(".popup-panel-tree-item-icon-toggler").removeClass("fa-plus-circle").addClass("fa-minus-circle");
				
				$(this).next(".popup-panel-tree-item-subpanel").slideToggle("slow",function() {					
					
					scroll.refresh();
					
				});
				
				this.parentNode.setAttribute("data-state",1);
				
			}
			
		});
		
		/*$(".btn-plus-layer").each(function(i,v) {
			
			$(v).on("click",function() {
				
				$(v).parent().next().slideToggle("slow");
					
				if ($(v).children("i").hasClass("fa-minus-circle")) {
					
					$(v).children("i").removeClass("fa-minus-circle");
					$(v).children("i").addClass("fa-plus-circle");
					
				}else{
						
					$(v).children("i").removeClass("fa-plus-circle");
					$(v).children("i").addClass("fa-minus-circle");
						
				}
				
			});
			
		});*/
		
		$("#btn-popup-basic").trigger("click");
		
		$(".layer-container-header .pretty .layer-checkbox").each(function(i,v) {
			
			$(v).on("click",function() {
				
				if (v.checked) {
					
					$(v).closest(".layer-container").find(".layer-container-body").find(".layer-checkbox:visible:not(:checked)").trigger("click");
					
				}else{
					
					$(v).closest(".layer-container").find(".layer-container-body").find(".layer-checkbox:visible:checked").trigger("click");				
					
				}
				
			});
			
		});
		
	}
	
	this.popup.fixSize = function(otherElements) {
		
		var docheight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
		var docwidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
		
		var otherElementsTotalHeight = 0;
		
		var left = $("#panel-left").width()+50;
		var nwidth = docwidth - left - 50;
		
		var windowTotalHeight = $(document).height();
		
		for (var i=0; i<otherElements.length; i++) {
			
			otherElementsTotalHeight += $(otherElements[i]).outerHeight();
		
		}
		
		var nheight = docheight - otherElementsTotalHeight;
		
		$("#popup-preloader").width(nwidth/3);
		$("#popup-preloader").css("top","50%");
		$("#popup-preloader").css("margin-top","-200px");
		$("#popup-preloader").css("left","50%");
		$("#popup-preloader").css("margin-left","-" + ((nwidth/3)/2) + "px");
		
		$("#print-legend-wrapper").width(nwidth/3);
		$("#print-legend-wrapper").height(300);
		
		$("#popup-buffer").css("right","20px");
		
		$("#info-wrapper").height(400);
		
	}

	this.popup.start = function() {
		
		this.startInterface();
		this.fixSize([document.getElementById("nav-1"),document.getElementById("nav-2")]);
		$(".popup").draggable({handle:".popup-header"});
		
	}
	
}